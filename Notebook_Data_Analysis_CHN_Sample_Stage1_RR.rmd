---
title: Notebook for  Data Analyses of Chinese Samples in Psychological Subjects [Stage
  1 RR]
author: "Lei Yue (NNU, CCNU); Hu Chuan-Peng (NNU; hcp4715@hotmail.com)"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) file for data analyses in the protocol of a meta research which aims at surveying sample characteristics of Chinese sample in Chinese Psychological research. 

In this script, we will use data from PSA 001 project [Jones et al., 2021, *Nature Human Behavior*](https://doi.org/10.1038/s41562-020-01007-2) to exemplify the analyses that we are going to use in our this project.

First, load libraries.

```{r Initialization, message=FALSE, warning=FALSE}
rm(list = ls())
if (!require("pacman")) install.packages("pacman") # install pacman, a package for managing packages in R

# packages needed
pkg_needed <- c("tidyverse", "ggridges", "openxlsx", "ggh4x", "stringr", "patchwork", "BayesFactor")
pacman::p_load(pkg_needed)  # load packages using p_load
library(tidyverse)
library(ggridges)
library(openxlsx)
library(ggh4x)
library(stringr)
library(patchwork)
```

# Bayesian multinomial test

## Background

We decide to use Bayesian multinomial test because it suits our purpose well: compare whether the observed distribution (sex, or age bins, etc) is sample from a population distribution (e.g., census data). In Frequentists' framework, this can be done by $\chi^2$ test (goodness-of-fit).

This can be done using JASP and a short introduction can be found here: Goss-Sampson, M. (2020, May 17). New Bayesian guide. https://doi.org/10.17605/OSF.IO/CKNXM. 

The function implemented in JASP can be found [here](https://github.com/jasp-stats/jaspFrequencies/blob/d48babf63b14526abaf2c208c8ae769801b6d4db/R/multinomialtestbayesian.R#L384). 

A more detailed explanation for multinomial test can be found in ([Sarafoglou et al., 2020](https://doi.org/10.31234/osf.io/bux7p), part 1). Here we also explain it below. 

## How does the JASP's multinomial work?

Essentially, the algorithm in JASP used Savage-Dickey likelihood ratio (Wagenmakers 2010) to calculate the BF. That is the likelihood of the data under the prior distribution and the likelihood of the data under the posterior distribution. 

Because multinomial distribution has nice conjugate prior, the Dirichlet distribution, the calculation of posterior of multinomial distribution does not requires MCMC. Thus, it is important to be clear about the following issues:
* What is the prior (in terms of conjugate prior, distribution of the parameters of multinomial).
* How to calculate the likelihood of the under the prior.
* How posterior is updated.
* How to calculate the likelihood under the posterior (which should be easy if the second question is known)

Before answering these questions, let's first have a look at the mulitnomial itself.

### Multinomial distribution & Dirichlet distribution

The multinomial distribution is a generalization of the binomial distribution, see [here more](https://en.wikipedia.org/wiki/Multinomial_distribution). 

The probability mass function (PMF) multinomial distribution is:

$$f(x_1, ..., x_k; n, p_1, ..., p_n) = Pr(X_1 = x_1 \, and \, ...  \, and \, X_k = x_k) = \frac{n!}{x_1! ... x_n!} p_1^{x_1} \times ... \times p_k^{x_k}$$
where $\sum_{i=1}^{k}{x_i=n}$, for non-negative integers $x_1, ..., x_k$

This PMF can be expressed using the gamma function as:

$$f(x_1, ..., x_k; n, p_1, ..., p_n) = \frac{\Gamma(\sum_{i}{x_i +1})}{\prod_{i}\Gamma(x_i + 1)} \prod_{i=1}^{k} p_{i}^{x_i}$$

The probability distribution of parameters of multinomial distribution $\theta = (\theta_1, \theta_2, ..., \theta_K)$ is a Dirichlet distribution with concentration parameters ($\alpha_1$, $\alpha_2$, ..., $\alpha_k$, where $\alpha > 0$:

$$p(\theta) = p(\theta_1, \theta_2, ..., \theta_k) = \frac {\Gamma(\sum_{k=1}^k \alpha_k)} {\sum_{k=1}^k\Gamma (\alpha_k)} \prod_{k=1}^k \theta_k^{\alpha_{k}-1} = \frac {1} {B(\alpha)} \prod_{k=1}^k \theta_k^{\alpha_{k}-1} $$

Posterior is also a Dirichlet distribution:

$$p(\theta | x) = \frac {\Gamma(N + \sum_{k=1}^k \alpha_k)} {\sum_{k=1}^k\Gamma (x_k + \alpha_k)} \prod_{k=1}^k \theta_k^{x_k + \alpha_{k}-1} = \frac {1} {B(\alpha + x)} \prod_{k=1}^k \theta_k^{x+k + \alpha_{k}-1} $$

If $H_0$ is a point null hypothesis, which is often specified as all parameters are equal. The alternative hypothesis, $H_a$, or $H_e$ in [Sarafoglou et al., 2020](https://doi.org/10.31234/osf.io/bux7p),  is a distribution, which states that all category proportions are free to vary without any ordinal restriction. 

### BF for multinomial test

Because $H_0$ is a point null hypothesis, the $BF_{0a}$ can be calculated using Savage-Dickey Ratio:

$$BF_{0e} = \frac {p(x | H_0)}{p(x | H_e)}  = \frac {p(x | \theta = c, H_e)}{\frac {p(x | \theta = c, H_e) p(\theta = c | H_e)} {p(\theta = c | x, H_e)}} = \frac {p(\theta = c \, | \, x, He)} {p(\theta = c \, | \, He)} $$

"The underlying principle of the Savage-Dickey density ratio is to compute the Bayes factor by dividing the height of the posterior density under He at the point of interest (i.e., c) by the height of the prior density under He at the same point."

Here prior, ($\alpha_1, ...$) is the parameters of Dirichlet distribution $Dir(\alpha_1, \alpha_2, ..., \alpha_k)$, which is not equal to $c$. Instead, $c$ is a point in the space that defined by Dirichlet distribution. The parameter $(\alpha_1 = 1, \alpha_1 = 2, ..., \alpha_K = 1)$ of Dirichlet distribution means that $c$ is equally possible with other set of $\theta$.

Using the prior and posterior distribution of Dirichlet, we can directly calculated the $BF_{0e}$

$$BF_{0e} = \frac {p(\theta = c \, | \, x, H_e)} {p(\theta = c \, | \, H_e)} =  \frac {1} {B(x+\alpha)} \prod_{k=1}^k \theta_k^{x_k + \alpha_{k}-1} / \frac {1} {B(\alpha)} \prod_{k=1}^k \theta_k^{\alpha_{k}-1} $$
$$BF_{0e} = \frac {p(\theta = c \, | \, x, H_e)} {p(\theta = c \, | \, H_e)} = \frac {Beta(\alpha)} {Beta(x + \alpha)} * \frac {\prod_{k=1}^k \theta_k^{x_k + \alpha_{k}-1}} {\prod_{k=1}^k \theta_k^{\alpha_{k}-1}}$$

$$BF_{e0} = 1/BF_{0e} = \frac {Beta(x + \alpha)} {Beta( \alpha)} * \frac {\prod_{k=1}^k \theta_k^{\alpha_{k}-1}} {\prod_{k=1}^k \theta_k^{x_k + \alpha_{k}-1}} $$
The above is the formula for the analytically solution of BF in R.

$$ log(BF_{e0}) = log(Beta(x + \alpha))- log(Beta( \alpha)) + (\sum_{k=1}^k \theta_k *(\alpha_{k}-1) - \sum_{k=1}^k \theta_k * (x_k + \alpha_{k}-1)) $$

### Algorithm in R

```
lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
```

Here, `alphas` defined the prior Dirichlet distribution, usually a vector of 1, `counts` are the observed frequencies.


To use the algorithm in R, we defined a function here:

```{r define BF for Multinomial test, message=FALSE, warning=FALSE}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  library(tidyverse)
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull() #  %>% as.factor(.)
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  if (default_prior & is.na(prior)) {
    prior <- rep(1, n_levels)
  } else{
    prior <- prior
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
    LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas)))  # what does it mean here????
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```

# Load data and preprocess the data

```{r Loading data, message=FALSE, warning=FALSE}

load("df_chinese_subj_rr_stage1.RData")
```

# Teset three hypotheses

## Test the 1st hypothesis
*This can only be done after collecting data.*

## Testing the 2nd hypothesis

Here we will test whether the sex ratio and age distribution from Chinese psychological studies are similar to that of the census data. As a comparison, we also compared that data from sociology, CFPS 2018, to the census data too. We use Bayesian multinomial test (Bayesian goodness-of-fit test) to examine whether the observed (Chinese psychological samples) fit the expected (7th Census data). 

$H_0$: $\theta = c$, where $c$ is defined by census data or CFPS 2018;
$H_1$: $\theta$ is free to vary.

### Sex distribution

```{r H2a sex, message=FALSE, warning=FALSE}
df_PSA001_sex_CN <- df_PSA001 %>%
  dplyr::filter(Countries == "CN") %>%
  dplyr::count(Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Site = "PSA001",
                Sex = ifelse(Sex == "f", 'female', 'male' )) %>%
  dplyr::select(Site, Sex, Proportion)

df_census7_sex <- df_census7 %>%
  dplyr::select(c(6,7)) %>%        
  dplyr::slice(c(6)) %>%
  dplyr::rename(male=1, 
                female=2) %>%
  dplyr::mutate(Site = "Census7") %>%
  tidyr::pivot_longer(c(male, female), 
                      names_to = "Sex",
                      values_to = "Proportion") %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion), 0))

df_CFPS2018_sex <- df_CFPS2018 %>%
  dplyr::rename(Sex = QA002) %>%
  dplyr::count(Sex) %>%
  dplyr::filter(!is.na(Sex)) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Site = "CFPS2018",
                Sex = ifelse(Sex == 1, "male", "female")) %>%
  dplyr::select(Site, Sex, Proportion)

df_sex_ratio <- rbind(df_census7_sex, df_CFPS2018_sex, df_PSA001_sex_CN)

### get the data for Bayesian mutlinomial test as in JASP
df_sex_ratio_jasp <- df_sex_ratio %>%
  tidyr::pivot_wider(names_from = Site,
                     values_from = Proportion)
## save to csv
write.csv(df_sex_ratio_jasp, "df_sex_ratio_jasp.csv", row.names=FALSE)

BF_h2a_sex_psych <- BayesMultiNomial(dataset = df_sex_ratio_jasp, factor = "Sex", observed = "PSA001", expected = "Census7")
BF_h2a_sex_cfps <- BayesMultiNomial(dataset = df_sex_ratio_jasp, factor = "Sex", observed = "CFPS2018", expected = "Census7")

## calculate the BF using contingency table:
BF_h2a_sex_psych_2 <- BayesFactor::contingencyTableBF(as.matrix(df_sex_ratio_jasp[, c(2,4)]), sampleType = "indepMulti", fixedMargin = "cols")

BF_h2a_sex_psych_2@bayesFactor$bf # which shows the logBF10

tmp <- df_sex_ratio_jasp[, c(2,4)] %>%
  dplyr::mutate(PSA001 = Census7 + PSA001 ) %>%
  as.matrix()

BF_h2a_sex_psych_3 <- BayesFactor::contingencyTableBF(tmp, sampleType = "indepMulti", fixedMargin = "cols")

fig3a <- ggplot(df_sex_ratio, aes(Site, Proportion,fill=Sex)) +
  geom_col() +
  theme_classic()+
  xlab("Data sources") +
  theme(legend.position = "bottom",
        legend.key.size = unit(20,"pt"),
        legend.box.spacing = unit(4,"pt"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16, family = "serif"),
        legend.text = element_text(size = 16, family = "serif"),
        axis.text = element_text(size =16, family = "serif"))

# fig3a  
```

We found strong evidence for the $H_1$ that the sex ratio from PSA001 is different from that of Census data, with $Log(BF_{10})$ = `r BF_h2a_sex_psych$BF$LogBF10`. On the contrast, for the CFPS data, we found moderate evidence for the $H_0$ that sex ratio from CFPS2018 is not different from that of Census data, $Log(BF_{10})$ = `r BF_h2a_sex_cfps$BF$LogBF10`

### Age distribution

Here we will compare the age distribution of samples from psychological studies (PSA 001 as the example) and the Census data.

```{r H2b ageBins plot, message=FALSE, warning=FALSE}
#  <- PSA_Jones_CN
df_PSA001_Age_CN <- df_PSA001 %>%
  dplyr::filter(!is.na(Age)) %>%
  dplyr::filter(Countries == "CN") %>%
  dplyr::mutate(ageBins_pyr = cut(Age, 
                                   breaks=c(-Inf, 5, 10, 15, 20, 25, 30, 35, 40, 45,
                                            50, 55,60,65,70, 75,80,85,90,95, Inf), 
                            labels=c("0~4","5~9","10~14", "15~19", "20~24", "25~29", "30~34", "35~39", "40~44",
                                     "45~49","50~54","55~59","60~64","65~69","70~74", "75~79",
                                     "80~84","85~89", "90~94",">=95")),
                ageBins_pyr = factor(ageBins_pyr, levels = c("0~4","5~9","10~14", "15~19", "20~24", "25~29", 
                                                             "30~34", "35~39", "40~44", "45~49","50~54",
                                                             "55~59","60~64","65~69","70~74", "75~79",
                                                             "80~84","85~89", "90~94",">=95"))) %>%
  dplyr::count(ageBins_pyr, Sex) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 4) * 100) %>%
  tidyr::complete(ageBins_pyr, Sex, fill=list(Proportion=0)) %>%
  dplyr::mutate(Site = "PSA001",
                Sex = ifelse(Sex == "f", "female_PSA", "male_PSA"))


df_census7_age94 <- df_census7 %>%
  dplyr::select(c(1,6,7)) %>%        
  dplyr::slice(c(8,15,22,29,36,43,
                 49,56,63,70,77,84,
                 91,98,105,112,119,
                 126,133)) %>%
  dplyr::rename(ageBins=1,
                male=2,
                female=3) %>%
  dplyr::mutate(ageBins = c("0~4","5~9","10~14", "15~19", "20~24",                                    "25~29", "30~34", "35~39", "40~44",     "45~49","50~54","55~59","60~64","65~69","70~74", "75~79",
                                     "80~84","85~89", "90~94"))

###Combining the data of 95 years old and above and controlling the number of the decimal places
df_census7_age95 <- data.frame(ageBins = c(">=95"),
                            male = round((271455 + 35129)/1409778724*100, 2),
                            female = round((548357 + 83737)/1409778724*100, 2))

df_census7_age <- rbind(df_census7_age94, df_census7_age95) %>%
  dplyr::mutate(ageBins = factor(ageBins, levels = c("0~4","5~9","10~14", "15~19", "20~24", "25~29", "30~34", 
                                                     "35~39", "40~44","45~49","50~54","55~59","60~64","65~69",
                                                     "70~74", "75~79", "80~84","85~89", "90~94",">=95"))) %>%
  tidyr::pivot_longer(-ageBins, names_to = "Sex", values_to = "Proportion") %>%
  dplyr::mutate(Proportion=as.numeric(Proportion))
  

### Plotting
fig3b <- ggplot(data= df_census7_age, aes(x=ageBins, y=ifelse(Sex=="male", -Proportion, Proportion), fill=Sex)) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = df_PSA001_Age_CN, aes(x=ageBins_pyr,
                                      y = ifelse(Sex == "male_PSA", -Proportion/2.5, Proportion/2.5),
                                      group=Sex,color="PSA001"), size=1, inherit.aes = FALSE) +
  scale_y_continuous(limits = c(-15,15),sec.axis = sec_axis(~.*2.5, name = "Proportion (PSA001)")) +
  coord_flip() +
  labs(y="Proportion (census data)", x = "Age bins", color=NULL)+
  annotate("text",label= "italic(Male)",x=19,y=-2,parse=TRUE,size=8, family = "serif") +
  annotate("text",label= "italic(Female)",x=19,y=3,parse=TRUE,size=8,family = "serif") +
  scale_color_manual(values = c("red","blue"))+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

fig3 <- fig3a + fig3b +  plot_annotation(tag_levels = 'A')
ggsave("fig3.pdf", fig3, device = "pdf", width=16, height = 9)

fig3
```

Also get the data for Bayesian multinomial test
```{r test H2b using BMT, message=FALSE, warning=FALSE}

df_PSA001_Age_CN_Jasp <- df_PSA001 %>%
  dplyr::filter(!is.na(Age)) %>%   
  dplyr::filter(Countries == "CN") %>% 
  dplyr::filter(!is.na(Age)) %>%
  dplyr::select(user_id, Countries, Sex, Age) %>%
  dplyr::mutate(ageBins=cut(Age, 
                            breaks=c(0, 9.5, 19.5, 29.5, 30.5, 40.5, 59.5, Inf), 
                            labels=c("0~9","10~19","20~29", "30~39", "40~49", "50~59", ">=60"))) %>%
  dplyr::count(Countries, ageBins) %>%
  dplyr::group_by(Countries) %>%
  dplyr::mutate(freq = (n / sum(n))*100) %>%
  dplyr::ungroup() %>%
  tidyr::complete(Countries, ageBins, fill = list(n = 0, freq = 0)) %>%
  dplyr::mutate(percent = floor(freq),
                indx = freq - percent) %>%
  dplyr::arrange(desc(indx))

if (sum(df_PSA001_Age_CN_Jasp$percent) < 100) {
    for (jj in seq(100 - sum(df_PSA001_Age_CN_Jasp$percent))){
     df_PSA001_Age_CN_Jasp$percent[jj] <- df_PSA001_Age_CN_Jasp$percent[jj] + 1
    }
}

df_PSA001_Age_CN_Jasp <- df_PSA001_Age_CN_Jasp %>%
  dplyr::select(ageBins, percent) %>%
  dplyr::rename(PSA001_CN = percent)

df_census7_age_jasp <- df_census7_age %>%
  tidyr::pivot_wider(names_from = "Sex", values_from = "Proportion") %>%
  dplyr::mutate(newAge = case_when(ageBins=="0~4" ~ "0~9",   ageBins == "5~9"   ~ "0~9",
                                   ageBins=="10~14"~"10~19", ageBins=="15~19"~"10~19", 
                                   ageBins=="20~24" ~ "20~29", ageBins=="25~29" ~ "20~29", 
                                   ageBins=="30~34" ~ "30~39", ageBins=="35~39" ~ "30~39",
                                   ageBins=="40~44" ~ "40~49", ageBins=="45~49" ~ "40~49", 
                                   ageBins=="50~54" ~ "50~59", ageBins=="55~59" ~ "50~59",
                                   ageBins=="60~64" ~ ">=60" , ageBins=="65~69" ~ ">=60",
                                   ageBins=="70~74" ~ ">=60",  ageBins=="75~79" ~ ">=60", 
                                   ageBins=="80~84" ~ ">=60",  ageBins=="85~89" ~ ">=60", 
                                   ageBins=="90~94" ~ ">=60",  ageBins==">=95" ~ ">=60")) %>%
  dplyr::group_by(newAge) %>%
  dplyr::summarise(newFemale = sum(female),
                   newMale = sum(male)) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Prop = newFemale + newMale) %>%
  dplyr::mutate(percent = floor(Prop),
                indx = Prop - percent) %>%
  dplyr::arrange(desc(indx))

if (sum(df_census7_age_jasp$percent) < 100) {
    for (jj in seq(100 - sum(df_census7_age_jasp$percent))){
     df_census7_age_jasp$percent[jj] <- df_census7_age_jasp$percent[jj] + 1
    }
  }

df_census7_age_jasp <- df_census7_age_jasp %>%
  dplyr::rename(Census7 = percent,
                ageBins = newAge) %>%
  dplyr::select(ageBins, Census7)

df_PSA001_Age_CN_Jasp_new <- df_PSA001_Age_CN_Jasp %>%
  dplyr::left_join(., df_census7_age_jasp) %>%
  dplyr::mutate(ageBins = factor(ageBins, levels = c( "0~9",
                                                      "10~19",
                                                      "20~29" ,
                                                      "30~39" ,
                                                      "40~49",
                                                      "50~59",
                                                      ">=60"))) %>%
  dplyr::arrange(ageBins)

BayesFactor::contingencyTableBF(as.matrix(df_PSA001_Age_CN_Jasp_new[,c(2,3)]), 
                                sampleType = "indepMulti", fixedMargin = "cols")

# save the CSV to compare the BayesMultiNomial with the result in JASP
write.csv(df_PSA001_Age_CN_Jasp_new, 'df_PSA001_Age_CN_Jasp_new.csv', row.names = F)

BF_h2b_age_psych <- BayesMultiNomial(dataset = df_PSA001_Age_CN_Jasp_new, 
                                     factor = "ageBins", 
                                     observed = "PSA001_CN",
                                     expected = "Census7")

```

We found strong evidence for the $H_1$ that the age distribution from PSA001 is different from that of Census data, with $Log(BF_{10})$ = `r BF_h2b_age_psych$BF$LogBF10`.

## Test H3
We first select data for plotting.
```{r preproc data}
### Get countries with n >=30
PSA001_valid_countries <-  df_PSA001 %>%
  dplyr::group_by(Countries) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::ungroup() %>%
  dplyr::filter(n >=30 & !is.na(Countries)) %>%
  dplyr::pull(Countries)

### remove data without sex info
df_PSA001_valid_sex <-  df_PSA001 %>% 
  dplyr::filter(Countries %in% PSA001_valid_countries) %>%
  dplyr::mutate(Sex = ifelse(Sex == "no" | Sex == "na", NA, Sex))


df_PSA001_valid_merge <- merge(df_PSA001_valid_sex, df_regionCode, by.x = "Countries", by.y = "country_iso2")

df_PSA001_valid_merge_sex_ratio <- df_PSA001_valid_merge %>%
  dplyr::filter(!is.na(Sex)) %>%
  dplyr::count(weird, Countries, Sex) %>%
  dplyr::group_by(weird, Countries) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2)) %>%
  dplyr::arrange(Sex, Proportion) %>%
  dplyr::ungroup()

countries_order_sex <- df_PSA001_valid_merge_sex_ratio %>%
  dplyr::filter(Sex == "f") %>%
  dplyr::pull(Countries)

df_PSA001_valid_merge_sex_ratio_sored <- df_PSA001_valid_merge_sex_ratio %>%
  dplyr::mutate(Countries = factor(Countries, levels = countries_order_sex))

# df_PSA001_valid_merge_sex_ratio_sored %>%
#   dplyr::mutate(Proportion = Proportion * 100) %>%
#   write.csv(., "PSA001_sex_ratio_all.csv", row.names = F)

df_PSA001_valid_merge_sex_ratio_sored_wide <- df_PSA001_valid_merge_sex_ratio_sored %>%
  dplyr::select(-c(weird,n)) %>%
  dplyr::mutate(Proportion = Proportion * 100)  %>%
  tidyr::pivot_wider(names_from = "Countries", values_from = "Proportion")

# df_PSA001_valid_merge_sex_ratio_sored_wide %>%
#   write.csv(., "Fig4a_sex_wide.csv", row.names = F)
```

```{r Test H3a,message=FALSE, warning=FALSE}
# compare each country with CN
BF_h3a_sex <- data.frame(matrix(nrow = 0, ncol = 5))
colnames(BF_h3a_sex) <- c("Observed", "Expected", "Log(BF10)", "BF10", "BF01")

# countries_names <- as.character(df_PSA001_valid_merge_sex_ratio_sored$Countries)
for (ii in seq(length(countries_order_sex))){
  country <- countries_order_sex[ii]
  if (country != "CN"){
    df_tmp <- df_PSA001_valid_merge_sex_ratio_sored_wide %>% dplyr::select('Sex', one_of(country), "CN")
    BF_tmp <-  BayesMultiNomial(dataset = df_tmp, 
                               factor = "Sex", observed = country, expected = "CN")
    BF_h3a_sex[ii,] <- c(country, "CN",BF_tmp$BF$LogBF10, BF_tmp$BF$BF10 , BF_tmp$BF$BF01)
  } 
}

BF_h3a_sex_p <- BF_h3a_sex %>%
  tidyr::drop_na() %>%
  dplyr::mutate(Contries = factor(Observed, levels = Observed),
                `Log(BF10)` = as.numeric(`Log(BF10)`)) 
  

p_BF_h3a_sex_p <- ggplot(BF_h3a_sex_p, aes( x = `Log(BF10)`, y = Contries )) +
  geom_point() +
  xlim(-3, 21) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10), log(1/6), 0, log(6), log(10)), 
             colour = c("red", "tomato", "black", "deepskyblue","blue"), 
             linetype=c("longdash", "longdash", "solid", "longdash","longdash")) + 
  geom_text(aes(x=log(10), label="\nStrong evidence for H1", y = 23), colour="blue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(6), label="Moderate evidence for H1\n", y = 23), colour="deepskyblue", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/6), label="\nModerate evidence for H0", y = 23), colour="tomato", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  ggtitle("Sex ratio") + 
  theme_bw() +
        theme(panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank(),
         panel.border = element_blank(),
         text = element_text(family='Times'),
         # legend.title=element_blank(),
         legend.title = element_text(size =16),
         legend.text = element_text(size =14),
         axis.text.x = element_text (size = 14, color = 'black',  hjust = 1),
         axis.text.y = element_text (size = 16, color = 'black'),
         plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
         axis.text = element_text (size = 16, color = 'black'),
         axis.title = element_text (size = 16),
         axis.title.x = element_text (size = 16),
         # axis.title.y = element_blank(),
         axis.title.y = element_text( size = 16),
         axis.line.x = element_line(color='black', size = 1),    
         axis.line.y = element_line(color='black', size = 1),    
         strip.text = element_text (size = 16, color = 'black'), 
         panel.spacing = unit(3, "lines")
        )
```

Plot figure 4a, 
```{r figure 4a }
fig4a <- ggplot(df_PSA001_valid_merge_sex_ratio_sored, aes(x=Proportion, y=Countries,fill=Sex)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + # , fill="Sex"
  scale_fill_discrete(label=c("female","male")) +
  theme_classic()+
  guides(y="axis_nested") +
  theme(legend.position = "none",
        legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 1, by = 0.1)) +
  facet_wrap(~ weird, scales = "free")
# fig4a
```

```{r preproc for age, message=FALSE, warning=FALSE}

df_PSA001_Age_valid <- df_PSA001 %>% 
  dplyr::filter(!is.na(Age)) %>%   
  dplyr::filter(Countries %in% PSA001_valid_countries) 

# merge with country code and force the age over 60 in a narrow range for visualization
df_PSA001_Age_valid_countryCode <- merge(df_PSA001_Age_valid, df_regionCode, by.x = "Countries", by.y = "country_iso2") %>%
  dplyr::mutate(Age = ifelse(Age > 60, sample(c(61, 62, 63, 64, 65), 1), Age))

PSA001_valid_countries_sorted <- df_PSA001_Age_valid_countryCode %>%
  dplyr::group_by(Countries) %>%
  dplyr::summarise(medianAge = median(Age)) %>%
  dplyr::ungroup() %>%
  dplyr::arrange(medianAge) %>%
  dplyr::pull(Countries)

df_PSA001_Age_valid_countryCode_sorted <- df_PSA001_Age_valid_countryCode %>%
  dplyr::mutate(Countries = factor(Countries, levels = PSA001_valid_countries_sorted)) %>%
  dplyr::filter(!(Sex=="no" | Sex=="na"))

### Plotting
fig4b <- ggplot(df_PSA001_Age_valid_countryCode_sorted, aes(x=Age, y=Countries, fill=Sex)) +
  geom_density_ridges(scale = 1, alpha = .75, size=0.5) +
  theme_classic() +
  guides(y="axis_nested") +
  labs(y="Countries") +
  scale_fill_discrete(label=c("female","male")) +
  facet_wrap(~weird, scales = "free") +
  coord_cartesian(clip = "off") +
  scale_y_discrete(expand = c(0,0)) +
  scale_x_continuous(expand = c(0,0)) +
  theme(legend.position = "none",
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        panel.border = element_rect(fill = NA,color = "black"),
        strip.background = element_rect(fill = NA,color=NA),
        strip.text = element_text(size = 15,family = "serif"))
# p_PSA001_Age

# save the plot
# fig4 <- (fig4a + fig4b) +  plot_annotation(tag_levels = 'A')
# ggsave("fig4.pdf", fig4, device = "pdf", width=16, height = 9)
# fig4
```

Get the percentage of each age bin and save for JASP
```{r prepare data for test}

df_PSA001_age_Jasp <- df_PSA001_Age_valid_countryCode_sorted %>%
  dplyr::select(user_id, Countries, Sex, Age) %>%
  dplyr::mutate(ageBins=cut(Age, 
                            breaks=c(0, 10.5, 20.5, 30.5, 40.5, 50.5, 60.5, Inf), 
                            labels=c("0~10","11~20","21~30", "31~40", "41~50", "51~60", ">=61"))) %>%
  dplyr::count(Countries, ageBins) %>%
  dplyr::group_by(Countries) %>%
  dplyr::mutate(freq = (n / sum(n))*100) %>%
  dplyr::ungroup() %>%
  tidyr::complete(Countries, ageBins, fill = list(n = 0, freq = 0)) %>%
  dplyr::mutate(percent = floor(freq),
                indx = freq - percent)

## below we fill the percentage to 100%
filler_idx <- df_PSA001_age_Jasp %>%
  dplyr::group_by(Countries) %>%
  dplyr::summarise(sum = sum(percent)) %>%
  dplyr::ungroup() 

df_PSA001_age_Jasp_filled <- data.frame(matrix(ncol = ncol(df_PSA001_age_Jasp), nrow = 0))
colnames(df_PSA001_age_Jasp_filled) <- colnames(df_PSA001_age_Jasp)

for (ii in 1:nrow(filler_idx)){
  tmp <- df_PSA001_age_Jasp %>% 
    dplyr::filter(Countries == filler_idx$Countries[ii]) %>%
    dplyr::arrange(desc(indx))
  
  if (filler_idx$sum[ii] < 100) {
    for (jj in seq(100 - filler_idx$sum[ii])){
     tmp$percent[jj] <- tmp$percent[jj] + 1
    }
  }
  df_PSA001_age_Jasp_filled <- rbind(df_PSA001_age_Jasp_filled, tmp)
}

df_PSA001_age_Jasp_filled <- df_PSA001_age_Jasp_filled %>%
  dplyr::arrange(Countries, ageBins) %>%
  dplyr::select(-indx)

filler_idx2 <- df_PSA001_age_Jasp_filled %>%
  dplyr::group_by(Countries) %>%
  dplyr::summarise(sum = sum(percent)) %>%
  dplyr::ungroup()  

# write.csv(df_PSA001_age_Jasp_filled, "fig4b_PSA001_age.csv", row.names = F)

df_PSA001_age_Jasp_filled_wide <- df_PSA001_age_Jasp_filled %>%
  dplyr::select(-c(n, freq)) %>%
  tidyr::pivot_wider(names_from = "Countries", values_from = "percent")
  
# df_PSA001_age_Jasp_filled_wide %>%
#   write.csv(., "Fig4b_ageBin_wide.csv", row.names = F)
```

```{r Test H3b,message=FALSE, warning=FALSE}
BF_h3b_age <- data.frame(matrix(nrow = 0, ncol = 5))

colnames(BF_h3b_age) <- c("Observed", "Expected", "Log(BF10)", "BF10", "BF01")

# countries_names <- as.character(df_PSA001_valid_merge_sex_ratio_sored$Countries)
for (ii in seq(length(countries_order_sex))){
  country <- countries_order_sex[ii]
  if (country != "CN"){
    df_tmp <- df_PSA001_age_Jasp_filled_wide %>% dplyr::select('ageBins', one_of(country), "CN")
    BF_tmp <-  BayesMultiNomial(dataset = df_tmp, 
                               factor = "ageBins", observed = country, expected = "CN")
    BF_h3b_age[ii,] <- c(country, "CN",BF_tmp$BF$LogBF10, BF_tmp$BF$BF10, BF_tmp$BF$BF01)
  } 
  
}

BF_h3b_age_p <- BF_h3b_age %>%
  tidyr::drop_na() %>%
  dplyr::mutate(Contries = factor(Observed, levels = Observed),
                `Log(BF10)` = as.numeric(`Log(BF10)`)) 
  

p_BF_h3b_age_p <- ggplot(BF_h3b_age_p, aes( x = `Log(BF10)`, y = Contries )) +
  geom_point() +
  xlim(-160, 0) +
  scale_y_discrete(limits=rev) +
  geom_vline(xintercept = c(log(1/10)), 
             colour = c("red"), 
             linetype=c("longdash")) + 
  geom_text(aes(x=log(1/10), label="Strong evidence for H0\n", y = 23), colour="red", alpha = 0.7, 
            angle=90, text=element_text(size=10)) +
  ggtitle("Age distribution") +
  theme_bw() +
        theme(panel.grid.major = element_blank(),
         panel.grid.minor = element_blank(),
         panel.background = element_blank(),
         panel.border = element_blank(),
         text = element_text(family='Times'),
         # legend.title=element_blank(),
         legend.title = element_text(size =16),
         legend.text = element_text(size =14),
         axis.text.x = element_text (size = 14, color = 'black',  hjust = 1),
         axis.text.y = element_text (size = 16, color = 'black'),
         plot.title = element_text(lineheight=.8, face="bold", size = 18, margin=margin(0,0,20,0)),
         axis.text = element_text (size = 16, color = 'black'),
         axis.title = element_text (size = 16),
         axis.title.x = element_text (size = 16),
         # axis.title.y = element_blank(),
         axis.title.y = element_text( size = 16),
         axis.line.x = element_line(color='black', size = 1),   
         axis.line.y = element_line(color='black', size = 1),    
         strip.text = element_text (size = 16, color = 'black'), 
         panel.spacing = unit(3, "lines")
        )

library(patchwork)
p_BF <- (p_BF_h3a_sex_p + p_BF_h3b_age_p) /
   (fig4a + fig4b) +
  plot_annotation( # title = 'Pairwise comparison between samples from China and other countries',
                  tag_levels = 'A')  & 
  theme(plot.tag = element_text(size = 18, face = "bold"))

ggsave("Fig4_withBF.pdf", p_BF, device = "pdf", width=15, height = 20)
p_BF
```
