---
title: "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V2"
author: "Lei Yue"
date: "2024-04-20"
output: html_document
---

In "Notebook_Data_Analysis_CHN_Sample_Stage2_RR_V1.Rmd"， We prereprocess the journal code data. In this Rmd(V2), we enter the informal process data.

# Install and Load packages
```{r message=FALSE, warning=FALSE}
rm(list = ls())

if (!require("pacman")) install.packages("pacman")

# use package "pacman" as loading R packages tools

pacman::p_load("tidyverse","here","rio")
pacman::p_load("geojsonsf","sf","RColorBrewer","ggspatial","patchwork","ggrepel","maps")
pacman::p_load("truncnorm","BayesFactor", "gtools", "bruceR")
```


# Load data
The data includes data from the first Stage 1 of the pre-registration report (primarily census data and CFPS2018 data), Chinese journal coding data, and data from Big Team Science (BTS).


## Load the data of stage 1 and Chinese journals coding data
```{r}
load("df_Pre_Stage2_Journal_Code.Rdata")

load("df_chinese_subj_rr_stage1.Rdata")
```


## Load the data of BTS
First, we convert some data that is not in .xlsx format.
```{r}
library(haven)

## read data
## BTS_Van_Bavel_et_al_2022
BTS_Van_Bavel_et_al_2022 <- haven::read_sav("BTS_Van_Bavel_et_al_2022.sav") %>% 
  dplyr::mutate(Gender = ifelse(Gender == 1, "Male", "Female"))

## BTS_Manokara_et_al_2022
BTS_Manokara_et_al_2022 <- haven::read_sav("BTS_Manokara_et_al_2022.sav") %>% 
  dplyr::mutate(Gender = ifelse(Gender == 1, "Male", "Female"))

## save data
write.csv(BTS_Van_Bavel_et_al_2022, file = "BTS_Van_Bavel_et_al_2022.csv",row.names = FALSE)
write.csv(BTS_Manokara_et_al_2022, file = "BTS_Manokara_et_al_2022.csv",row.names = FALSE)
```


Then, we load all BTS data.
```{r message=FALSE, warning=FALSE, include=FALSE}
file_list <- list.files(here("D://chin-subj//2_Data_Extraction//2_1 CHN_Journal_Code//2_2_6_Data_Analysis"), ## If you need to learn or repeat the code document, please replace it with your local file address
                        pattern = ".csv",
                        full.names = TRUE,
                        recursive = TRUE)

BTS_data_list <- list()  
 
for (file in file_list) {  
    
  BTS_file <- readr::read_csv(file)  
  BTS_data_list[[tools::file_path_sans_ext(basename(file))]] <- BTS_file  

}  

BTS_data_list <- BTS_data_list[grepl("BTS_",names(BTS_data_list),ignore.case = TRUE)]

BTS_data <- BTS_data_list
rm(BTS_file)

BTS1 <- BTS_data[[12]]
```


### Process Country code of BTS
Uniform country codes facilitate subsequent data processing and analysis, especially for batch processing and analysis of data.
#### Create a unified table of country codes
```{r}
if(!require("countrycode")) install.packages("countrycode")

Countrycodelist <- codelist

Countrycodelist_iso2_iso3 <- Countrycodelist %>% 
  dplyr::select(country.name.en,iso2c,iso3c) %>% 
  dplyr::rename(Countryfullname = 1,ISO2 = 2, ISO3 = 3)

Countrycodelist_iso2_iso3$ISO2[Countrycodelist_iso2_iso3$Countryfullname == "Kosovo"] <- "XK"
Countrycodelist_iso2_iso3$ISO3[Countrycodelist_iso2_iso3$Countryfullname == "Kosovo"] <- "XKX"
```

#### Create dataframe of WEIRD to visuliazation
```{r}
WEIRD_code <- codelist %>% 
  dplyr::select(3,6,iso2c,iso3c,region,region23) %>% 
  dplyr::mutate(WEIRD = ifelse(continent == "Europe" | region == "North America","WEIRD",NA),
                WEIRD = ifelse(continent %in% c("Africa","Asia") | region == "Latin America & Caribbean" | region == "East Asia & Pacific", "Non_WEIRD",WEIRD)) %>% 
  dplyr::mutate(WEIRD = ifelse(country.name.en %in% c("Israel","Australia","New Zealand"), "WEIRD",WEIRD),
                WEIRD = ifelse(is.na(WEIRD),"Non_WEIRD",WEIRD))

#table(WEIRD_code$region)
```


#### Batch country code of BTS
```{r}
## Handle some more specific encodings
BTS_data[[5]]$Country <- trimws(sub(".*-(\\s*)", "", BTS_data[[5]]$Country)) 
BTS_data[[12]]$Country <- trimws(sub(".*-(\\s*)", "", BTS_data[[12]]$Country)) 
names(BTS_data[[11]])[names(BTS_data[[11]]) == "Country_now"] <- "Country"


## Batch processing of country codes for different data sources
BTS_data <- lapply(BTS_data,function(df){
  
  df <- df %>% 
    mutate(#Country = toupper(Country),
           Country = case_when(Country %in% c("TW","HK","MO") ~ "CN",
                               Country %in% c("TWN","HKG","MAC") ~ "CHN",
                               Country %in% c("Taiwan","Macao","Hong Kong, China","Hong Kong") ~ "China",
                               Country %in% c("Bosnia and Herzegovina","Bosnia and. Herz.") ~ "Bosnia & Herzegovina",
                               Country %in% c("England","Northern Ireland","Wales") ~ "United Kingdom",
                               Country %in% c("SlovakRepublic") ~ "Slovakia",
                               Country %in% c("Czech Republic") ~ "Czechia",
                               Country %in% c("Macedonia") ~ "North Macedonia",
                               Country %in% c("The Netherlands") ~ "Netherlands",
                               #Country %in% c("US","USA") ~ "United States",
                               TRUE ~ Country
                               ),
           Country = toupper(Country),
           Country = ifelse(nchar(Country) > 3, str_to_title(Country),Country),
           Countrycode = ifelse(nchar(Country) > 3, "Countryfullname", 
                                ifelse(nchar(Country) == 3, "ISO3", "ISO2")))
  
  return(df)
  
})


## Check the country code of the BTS data
BTS_countrycode_check <- lapply(BTS_data, function(df){
  
  df <- df %>% 
    dplyr::group_by(Countrycode) %>% 
    dplyr::summarise(n=n()) %>% 
    dplyr::ungroup()
  
  return(df)
})

BTS_countrycode_check <- do.call(rbind, BTS_countrycode_check)

## process abnormal Countrycode
BTS_data[[4]] <- BTS_data[[4]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "USA", "Countryfullname",Countrycode)) ## I found UEA, a non-country code

BTS_data[[5]] <- BTS_data[[5]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "Ken, Na", "ISO3",Countrycode),
                Country = ifelse(Country == "Ken, Na", "KEN",Country))

BTS_data[[6]] <- BTS_data[[6]] %>% 
  dplyr::mutate(Countrycode = ifelse(Country == "Many", NA,Countrycode),
                Country = ifelse(Country == "Many", NA, Country))
  


## Combine the BTS_data and Countrycodelist_iso2_iso3
Countrycode_merge <- function(df, Countrycode) {  
  
  Countrycode_lengths <- nchar(as.character(df$Country))  
  Countrycode_lengths <- Countrycode_lengths[!is.na(Countrycode_lengths)]  
 
  if (all(Countrycode_lengths == 2)) {  
    
    merge_key <- "ISO2"  
  } else if (any(Countrycode_lengths > 3)) {  
   
    merge_key <- "Countryfullname"  
  } else {  
   
    merge_key <- "ISO3"  
  }  
    
  merged_df <- merge(df, Countrycode, by.x = "Country", by.y = merge_key, all.x = TRUE)  
    
  return(merged_df)  
}  
  
BTS_data <- lapply(BTS_data, Countrycode_merge, Countrycode = Countrycodelist_iso2_iso3)  


## Change the column name so that each BTS data has "ISO3"
BTS_data <- lapply(BTS_data,function(df){
  
  if(!"ISO3" %in% names(df)){
    
    df <- df %>% 
      dplyr::mutate(ISO3 = Country)
  }
  
  return(df)
  
})


## Change the column name so that each BTS data has "ISO2"
BTS_data <- lapply(BTS_data,function(df){
  
  if(!"ISO2" %in% names(df)){
    
    df <- df %>% 
      dplyr::mutate(ISO2 = Country)
  }
  
  return(df)
  
})


## Because the country code of the countrycode package is the full name, but some of the actual data set is recorded by abbreviation (for example: United States is USA), so this part is not converted properly, and is now found and processed separately.
BTS_data_na <- lapply(BTS_data, function(df){
  
  df <- df %>% 
    dplyr::filter(is.na(ISO3)) %>% 
    dplyr::select(Article_Id, Country, ISO3)
  
  return(df)
})

BTS_data_na <- do.call(rbind,BTS_data_na)

BTS_data_na_table <- data.frame(table(BTS_data_na$Country)) 


## Handle UK and UA separately
BTS_data <- lapply(BTS_data,function(df){
  
  df <- df %>% 
    dplyr::mutate(ISO2 = ifelse(Country == "UK" |Country == "UEA","GB",ISO2),
                  ISO2 = ifelse(Country == "US" | Country == "USA", "US",ISO2),
                  ISO3 = ifelse(Country == "UK"|Country == "UEA","GBR",ISO3),
                  ISO3 = ifelse(Country == "US" | Country == "USA", "USA",ISO3))
  
  return(df)
  
})

```


# Define a Func to calculate Bayesian multinomial test
## Algorithm in R
```
lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
```


Here, `alphas` defined the prior Dirichlet distribution, e.g., noninformative prior is a vector of $1$s, `counts` are the observed frequencies.

To use the algorithm in R, we defined a function here:
```{r}
BayesMultiNomial <- function(dataset, factor, observed, expected, default_prior = TRUE, prior = NA){
  # datase - the input dataframe
  # factor - column name of the factor,
  # observed - column name of the column contains counts information for the observed,
  # expected - column name of the column contains counts information for the expected,
  # default_prior - whether use the default, defused prior
  # prior - priors defined by users
  
  fact_level <- dataset %>% dplyr::select(all_of(factor)) %>% dplyr::pull()
  observed_data <- dataset %>% dplyr::select(all_of(observed)) %>% dplyr::pull()
  names(observed_data) <- fact_level
  expected_data <- dataset %>% dplyr::select(all_of(expected)) %>% dplyr::pull()
  n_levels <- length(observed_data)
  
  
  if (default_prior & all(is.na(prior))) {
    prior <- rep(1, n_levels)
  } else{
    if (is.character(prior)){
      prior <- dataset %>% dplyr::select(all_of(prior)) %>% dplyr::pull()
    } else if (is.array(prior)){
      prior <-  prior
    } else if (is.numeric(prior)){
      prior <-  prior
    } else{
      print("prior much a column of the input data or a vector")
    }
  }
  
  alphas <- prior
  counts <- observed_data
  thetas <- expected_data
  
  if(sum(thetas) != 1) {
    thetas <- thetas/sum(thetas)
    }
  
  expected <- setNames(sum(counts)*thetas, names(counts))
  
  lbeta.xa <- sum(lgamma(alphas + counts)) - lgamma(sum(alphas + counts))
  lbeta.a  <- sum(lgamma(alphas)) - lgamma(sum(alphas))

  if (any(rowSums(cbind(thetas, counts)) == 0)) {
    LogBF10 <- (lbeta.xa-lbeta.a)
  } else {
    LogBF10 <- (lbeta.xa-lbeta.a) + (0 - sum(counts * log(thetas))) 
  }

  BF <- data.frame(LogBF10 = LogBF10,
                   BF10    = exp(LogBF10),
                   BF01    = 1/exp(LogBF10))

  return(list(BF       = BF,
              expected = expected))
  
}
```


# Overview of participants

## The basic situation of Chinese jourlnals coding data
```{r}
### In order to facilitate the subsequent exclusion of foreign samples, the Subjects_Recruitment_Area information 29 of 20211064 was changed to Chinese character 29
df_stage2_Journal_Code2$Subjects_Recruitment_Area[447] <- "被试填答IP覆盖了二十九个省、自治区、直辖市"


df_Articles <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area))

df_articles_num <- df_Articles %>% 
  dplyr::distinct(Article_IDs)

df_study_num <- df_Articles %>% 
  dplyr::distinct(Article_IDs,Study_Number)
```


## The basic situation about BTS data
```{r}
BTS_Overview <- lapply(BTS_data,function(df){
  
  df <- df %>% 
    dplyr::select(Article_Id,ISO3,ISO2)
  
  return(df)
})

BTS_Overview <- do.call(rbind,BTS_Overview)

BTS_Overview2 <- BTS_Overview %>% 
  dplyr::filter(!is.na(ISO2)) %>%   ## ISO2 is used to subsequent visualize the spatial distribution in and filter out the data with countries as NA.
  dplyr::group_by(ISO2) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2),
                FloorPro = floor(Proportion),
                index = Proportion - FloorPro,
                Site = "BTS")

sum(BTS_Overview2$Proportion)


BTS_Overview2_idx <- BTS_Overview2 %>% 
  group_by(Site) %>% 
  summarise(sum = sum(FloorPro)) %>% 
  ungroup()

```


## try percent 100
```{r}
bts_overviewfill <- data.frame(matrix(ncol = ncol(BTS_Overview2),nrow = 0))
colnames(bts_overviewfill) <- colnames(BTS_Overview2)

for (i in 1:nrow(BTS_Overview2_idx)) {
  
  df55 <- BTS_Overview2 %>% 
    dplyr::filter(Site == BTS_Overview2_idx$Site[i]) %>% 
    dplyr::arrange(desc(index))
  
  if(BTS_Overview2_idx$sum[i] < 100) {
    
    for(j in seq(100 - BTS_Overview2_idx$sum[i])){
      
      df55$FloorPro[j] <- df55$FloorPro[j] + 1
    }
      bts_overviewfill <- rbind(bts_overviewfill,df55)
  }

   return(bts_overviewfill)

}

sum(bts_overviewfill$FloorPro)
```


## The reported situation of Chinese Journals
### Process reported situations data of Chinese Journals
```{r}
df_CHN_report <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::mutate(Subjects_Recruitment_Area = ifelse(Subjects_Recruitment_Area == 0, 0, 1),
                Sampling_Method = ifelse(Sampling_Method == 0, 0 ,1),
                SES_N = ifelse(SES_N == 0, 0, 1),
                Subjects_Recruitment_Method_N = ifelse(Subjects_Recruitment_Method_N == 0, 0, 1)) %>%
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Age = max(Age) > 0,
                   Gender = max(Gender) > 0,
                   Religious = max(Religious) > 0,
                   Ethnicity = max(Ethnicity) > 0,
                   Sampling_Method = max(Sampling_Method) > 0,
                   Recruitment_Area = max(Subjects_Recruitment_Area) > 0,
                   Recruitment_Method = max(Subjects_Recruitment_Method_N) > 0,
                   SES = max(SES_N) > 0) %>% 
  dplyr::ungroup() %>% 
  dplyr::select(3:last_col())

report_list <- list()

for (i in names(df_CHN_report)){
  
  
  report_table <- data.frame(table(df_CHN_report[[i]])) %>% 
    dplyr::mutate(col_names = names(df_CHN_report[i]),
                  proportion = round(Freq / sum(Freq),2))
  
  report_list[[i]] <- report_table
  
}

df_CHN_report <- do.call(rbind, report_list) %>% 
  dplyr::mutate(Var1 = ifelse(Var1 == "TRUE", "Reported","Unreported")) 



### Calculate reported status of Educational_Attainment and Occupation
Educational_Occupation <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>%
  dplyr::filter(Sample_Type_N %in% c(4,5)) %>% 
  dplyr::group_by(Article_IDs,Study_Number) %>% 
  dplyr::summarise(Educational_Attainment_N = max(Educational_Attainment_N) > 0,
                Occupation_N = max(Occupation_N) > 0) %>% 
  dplyr::ungroup()  ### 294 studies

table(Educational_Occupation$Educational_Attainment_N) ## FALSE 162 TRUE 132
table(Educational_Occupation$Occupation_N)  ## FALSE 193 TRUE 101


Educational_Occupation_table <- data.frame(Var1 = c("Unreported","Reported","Unreported","Reported"),
                                           Freq = c(162,132,193,101),
                                           col_names= c("Educational_Attainment","Educational_Attainment","Occupation","Occupation"),
                                           proportion = c(0.55,0.45,0.66,0.34))

df_CHN_report <- rbind(df_CHN_report,Educational_Occupation_table) %>% 
  dplyr::mutate(col_names = factor(col_names, 
                                   labels = c("Gender","Age","Recruitment Method","Recruitment Area","Educational Attainment",
                                              "Occupation","Sampling Method","SES","Ethnicity","Religious"
                                             ),
                                   levels = c("Gender","Age","Recruitment_Method","Recruitment_Area","Educational_Attainment",
                                              "Occupation","Sampling_Method","SES","Ethnicity","Religious")))
```


### Visualize subjects information reported  situations in Chinese journals 
```{r}
Fig_Journal_report <- ggplot(df_CHN_report,aes(col_names,proportion,fill=Var1))+
  geom_col()+
  labs(x="",y="%")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))+
  scale_x_discrete(guide = guide_axis(angle = 45))+
  scale_fill_manual(values = c("#00BFC4","#B2B2B2"))

Fig_Journal_report

ggsave("Fig_Journal_report.pdf", Fig_Journal_report, device = "pdf", width=16, height = 9)
```


### Specific reports on some demographic categories
```{r}
df_age_report_detail <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Age,M_age,SD_age,Other_age) %>%
  dplyr::filter(Age == 1)

### Age report studies num
df_age_report_detail_study_num <- df_age_report_detail %>%
    dplyr::distinct(Article_IDs,Study_Number) ## 989 studies
  

### Age fuzzy report studies num
df_fuzzy_age_report <- df_age_report_detail %>% 
  dplyr::filter(is.na(M_age)) 

## 20082227,20083017,20183340,20183097,20214027 Other age include Mage
##这里后面还需要重新处理一下部分Otherage包含Mage的情况

df_fuzzy_age_report_study_num <- df_fuzzy_age_report %>% 
  dplyr::distinct(Article_IDs,Study_Number) ## 130-5=125
```


# Test three hypotheses
## Test the 1st hypothesis

### Gender
#### Process gender data from census
```{r}
## Process the gender data of census 7
df_census7_Gender <- df_census7 %>%
  dplyr::select(c(6,7)) %>%        
  dplyr::slice(c(6)) %>%
  dplyr::rename(male=1, 
                female=2) %>%
  dplyr::mutate(Data_Source = "Census 7") %>%
  tidyr::pivot_longer(c(male, female), 
                      names_to = "Gender",
                      values_to = "Proportion") %>%
  dplyr::mutate(Proportion = round(as.numeric(Proportion), 0))

## Process the gender data of CFPS2018
df_CFPS2018_Gender <- df_CFPS2018 %>%
  dplyr::rename(Gender = QA002) %>%
  dplyr::count(Gender) %>%
  dplyr::filter(!is.na(Gender)) %>%
  dplyr::mutate(Proportion = round(n / sum(n), 2) * 100,
                Data_Source = "CFPS 2018",
                Gender= ifelse(Gender == 1, "male", "female")) %>%
  dplyr::select(Data_Source, Gender, Proportion)
```


#### Process gender data from Chinese sample in Chinese journal
```{r warning=FALSE}
## Minor revision
df_stage2_Journal_Code2$Male_Num[1258] <- 0


## Process the gender data of CHN Journal
df_stage2_Journal_Code_Gender <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(Subjects_Recruitment_Area !=2) %>% 
  dplyr::mutate(Male_Num = as.numeric(Male_Num),
                Female_Num = as.numeric(Female_Num)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group_N,Sample_Size,Gender,Male_Num,Female_Num,Remark1,Remark2,Remark3)


## Part of the gender data is the proportion recorded, and part is the number of people, so I deal with it separately.

df_stage2_Journal_Code_Gender_decimal <- df_stage2_Journal_Code_Gender %>% 
  dplyr::filter(Gender == 1) %>% 
  dplyr::filter(Male_Num < 1 & Female_Num < 1) %>% 
  dplyr::select(Article_IDs,Sample_Size,Study_Number,Subjects_Group_N,Gender,Male_Num,Female_Num) %>% 
  dplyr::mutate(Male_Num = round(Male_Num,2),
                Female_Num = round(Female_Num,2)) %>% 
  dplyr::rename(Male_Proportion = Male_Num,
               Female_Proportion =  Female_Num)

df_stage2_Journal_Code_Gender_integer <- df_stage2_Journal_Code_Gender %>%
  dplyr::filter(Gender == 1) %>% 
  dplyr::filter(Male_Num > 1 | Female_Num > 1) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group_N,Sample_Size,Gender,Male_Num,Female_Num)


## Multiple groups of data are removed during processing, so re-create the data.frame and then merge them.

df_stage2_Journal_Code_Gender_integer_add <- data.frame(
  Article_IDs = c("20185082","20213045","20213048","20213048","20215075"),
  Study_Number = c(1,1,1,2,1),
  Subjects_Group_N = c(NA,NA,NA,NA,"父亲"),
  Sample_Size = c(33,81,68,59,310),
  Gender = 1,
  Male_Num = c(26,49,31,28,310),
  Female_Num = c(7,32,37,31,0))


df_stage2_Journal_Code_Gender_integer <- df_stage2_Journal_Code_Gender_integer %>% 
  rbind(df_stage2_Journal_Code_Gender_integer_add) %>% 
  dplyr::mutate(Female_Num = ifelse(is.na(Female_Num), 0, Female_Num),
                Sample_Size = as.numeric(Sample_Size)) %>%
  dplyr::mutate(Male_Proportion = Male_Num/Sample_Size) %>% 
  dplyr::mutate(Male_Proportion = round(Male_Proportion,2)) %>% 
  dplyr::mutate(Female_Proportion = 1 - Male_Proportion) %>% 
  dplyr::select(-c(6:7))
  
## rm(df_stage2_Journal_Code_Gender_integer_add)

df_CHN_Journal_Gender <- rbind(df_stage2_Journal_Code_Gender_decimal,
                               df_stage2_Journal_Code_Gender_integer)

df_CHN_Journal_Gender_Total <- df_CHN_Journal_Gender %>%
  dplyr::summarise(male = round(mean(Male_Proportion),2),
                   female = round(mean(Female_Proportion),2)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Data_Source = "CHN Journal") %>% 
  tidyr::pivot_longer(c(male,female), 
                      names_to = "Gender") %>% 
  dplyr::rename(Proportion = 3)

```


#### Process gender data from BTS 
```{r echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
BTS_gender_list <- list()

for(i in seq_along(BTS_data)) {
  
  BTS_data_name <- names(BTS_data)[i] 
  
 if ("Gender" %in% names(BTS_data[[i]])) {  
   
  BTS_gender <- BTS_data[[i]] %>% 
    dplyr::mutate(Gender = str_to_title(Gender)) %>% 
    dplyr::filter(Gender == "Female" | Gender == "Male") %>% 
    #dplyr::group_by(ISO3,Gender) %>% 
    #dplyr::summarise(count = n()) %>%
    dplyr::mutate(#Proportion = round(count/sum(count),2),
                  Data_Source =  BTS_data_name)
    #dplyr::ungroup()
  
  BTS_gender_list[[BTS_data_name]] <- BTS_gender
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Gender' column.\n", BTS_data_name))  
  } 

}

#BTS1 <- BTS_gender_list[[1]] 

```


#### Combine gender data from Chinese Journal and BTS
```{r}
## Extracting China data
BTS_CHN_gender <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::filter(grepl("CHN", ISO3, ignore.case = TRUE)) %>% 
    dplyr::select(ISO3,Data_Source,Gender) 

})

BTS_CHN_gender <- do.call(rbind, BTS_CHN_gender) %>% 
  dplyr::group_by(Gender) %>% 
  dplyr::summarise(n = n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n),2)*100) %>% 
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS CHN")
  
  

## Combine CHN journal data and set factor
df_CHN_Journal_Gender_Total2 <- df_CHN_Journal_Gender_Total %>% 
  dplyr::mutate(Proportion = Proportion * 100)

Journal_BTS_CHN_gender <- BTS_CHN_gender %>% 
  bind_rows(df_CHN_Journal_Gender_Total2) %>% 
  dplyr::mutate(Gender =  stringr::str_to_title(Gender))

Journal_BTS_CHN_gender_factor <- Journal_BTS_CHN_gender %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(Data_Source)

Journal_BTS_CHN_gender <- Journal_BTS_CHN_gender %>% 
  dplyr::mutate(Data_Source = factor(Data_Source,
                                     levels = Journal_BTS_CHN_gender_factor))
```


#### Visualize gender data for Chinese journals and BTS
```{r}
Fig_Journal_BTS_CHN_gender <- ggplot(data = Journal_BTS_CHN_gender,aes(Data_Source,Proportion,fill = Gender))+
  geom_col()+
  geom_hline(yintercept = 50, linetype = "dashed", color = "#666666")+
  labs(y="Proportion")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 20, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 20,family = "serif"),
        axis.text = element_text(size = 20,family = "serif"))#,
      #  axis.text.x = element_text(angle = 90, hjust = 1))

ggsave("Fig_Journal_BTS_CHN_gender.pdf", Fig_Journal_BTS_CHN_gender, device = "pdf", width=18, height = 9)

Fig_Journal_BTS_CHN_gender

BTS1 <- Journal_BTS_CHN_gender$data
```


#### Bayesian multinomial test for CHN journal data and BTS
Here we will test whether the gender proportion distribution from Chinese five journal data are similar to that of the BTS data. We use Bayesian multinomial test (Bayesian goodness-of-fit test) to examine whether the observed (BTS data) fit the expected (Chinese five journal data). 

$H_0$: $\theta = c$, where $c$ is defined by Chinese five journal data;
$H_1$: $\theta$ is free to vary.

```{r}
Journal_BTS_CHN_gender_bayes <- Journal_BTS_CHN_gender %>% 
  dplyr::select(1,3:4) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)

BF_H1_Gender_Jouranl_BTS <- BayesMultiNomial(dataset = Journal_BTS_CHN_gender_bayes,
                                             factor = "Gender",
                                             observed = "BTS CHN",
                                             expected = "CHN Journal") 
```


We found moderate evidence for the $H_1$ that the gender proportion from Chinese five journal data is different from that of BTS data, with $Log(BF_{10})$ = `r BF_H1_Gender_Jouranl_BTS$BF$LogBF10`.


### Age
#### Re-process age data from Chinese sample in Chinese journal
```{r warning=FALSE}
## I found some outliers for M_age, so I processed this part of the data first.
df_stage2_Journal_Code2$Sample_Type_N[1082] <- 2
df_stage2_Journal_Code2$Sample_Type_N[183] <- 2
df_stage2_Journal_Code2$Sample_Type_N[1190:1191] <- 2
df_stage2_Journal_Code2$M_age[1500] <- 31.6
df_stage2_Journal_Code2$M_age[407] <- "男性69.14;女性67.16"
df_stage2_Journal_Code2$M_age[1039] <- NA
df_stage2_Journal_Code2$M_age[1041] <- NA
df_stage2_Journal_Code2$SD_age[1039] <- NA
df_stage2_Journal_Code2$SD_age[1041] <- NA
df_stage2_Journal_Code2$M_age[1052] <- NA
df_stage2_Journal_Code2$SD_age[1052] <- NA
df_stage2_Journal_Code2$Sample_Type_N[300] <- 3
df_stage2_Journal_Code2$Age[351:352] <- 0 ## 20182022 Original article age report error, 0 here


## In the following process, we found 3 rows include Mage = 0 and SDage = 0.
## 20182182
df_stage2_Journal_Code2$M_age[1040] <- NA
df_stage2_Journal_Code2$M_age[1042] <- NA
df_stage2_Journal_Code2$M_age[1053] <- NA

df_stage2_Journal_Code2$SD_age[1040] <- NA
df_stage2_Journal_Code2$SD_age[1042] <- NA
df_stage2_Journal_Code2$SD_age[1053] <- NA

## Filter M_age have multiple group data
df_stage2_Journal_Code_Age_str <- df_stage2_Journal_Code2 %>% 
  dplyr::slice(492,370,856,879,1406,726,725,724,1413,
               1288,489,322,1331,1324,407,362,374,495,
               1419) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Type_N,Age,M_age,SD_age,Other_age,Remark1,Remark2,Remark3)



## Rebuild for M_age' multiple group of data
df_stage2_Journal_Code_Mage_multiple_group <- data.frame(
  Article_IDs = c(20213254,20213254,20183078,20183078,20183078,20184162,20184162,20212079,
                  20212079,20213045,20213045,20213045,20082296,20082296,20082296,20082296,
                  20082296,20082296,20213054,20213054,20181109,20181109,20213244,20213244,
                  20182003,20182003,20182228,20182228,20182207,20182207,20184083,20184083,
                  20183060,20183060,20183087,20183087,20215094,20215094,20215094,20215075,20215075),
  Study_Number = 1,
  Subjects_Group = c("样本1大学生","样本1高中生","儿童","父亲","母亲","父亲","母亲","高一",
                     "高二","精分患者","健康同胞","健康对照","小班男","小班女","中班男","中班女",
                     "大班男","大班女","男生","女生","男生","女生","男生","女生",
                     "男生","女生","男生","女生","男生","女生","男生","女生",
                     "男生","女生","男生","女生","四年级","五年级", "六年级","幼儿","父亲"),
  Sample_Type_N = c(1,2,2,4,4,4,4,2,2,4,4,
                    4,3,3,3,3,3,3,3,3,2,
                    2,1,1,1,1,2,2,4,4,4,
                    4,1,1,1,1,2,2,2,3,4),
  Age = 1,
  M_age = c(21.12,16.44,9.74,39.15,36.99,41.44,40.23,15.36,16.35,25.44,
            25.56,27.44,3.77,3.85,4.73,4.83,5.68,5.77,4.69,4.79,
            14.23,14.08,18.71,18.84,21.63,21.89,10.01,9.95,27.90,
            26.75,69.14,67.16,20.94,21.51,21.10,21.80,10.10,11.07,
            12.03,5.02,36.11),
  SD_age = c(1.45,0.73,1.46,3.73,2.95,NA,NA,0.52,0.52,5.92,6.44,7.24,
             0.3,0.23,0.25,0.29,0.32,0.32,0.58,0.56,0.69,0.58,1.78,1.66,
             1.32,1.17,1.31,1.38,6.56,5.04,7.40,6.44,2.33,2.31,2.37,1.69,
             0.31,0.34,0.30,0.93,4.91),
  Other_age = NA,
  Remark1 = NA,
  Remark2 = NA,
  Remark3 = NA)


## Process Other_age information separately
df_stage2_Journal_Code_Mage_multiple_group$Other_age[1] <- "17-25"
df_stage2_Journal_Code_Mage_multiple_group$Other_age[2] <- "15-19"



## I found that there are some M_age that have multiple groups, but no Chinese character identification, so it is not recognized in the above filter, so it is dealt with separately here

df_stage2_Journal_Code_Mage_semicolon <- data.frame(
  Article_IDs = c(20084068,20084068,20084068,20084068,20084068,20084068,20082182,20082182,
                  20082182,20082182,20185082,20185082,20183133,20183133,20182052,20182052,
                  20182052,20182052,20212031,20212031,20184130,20184130,20215102,20215102),
  Study_Number = c(1,1,1,1,1,1,1,1,2,2,1,1,
                   1,1,1,1,2,2,1,1,1,1,1,1),
  Subjects_Group = c("中班男","中班女","小班男","小班女","大班男","大班女",
                     "6、7岁","10、11岁","6、7岁","10、11岁","男生","女生",
                     "男生","女生","男生","女生","男生","女生","男生","女生",
                     "父亲","母亲","父亲","母亲"),
  Sample_Type_N =c(3,3,3,3,3,3,2,2,2,2,3,3,
                   1,1,5,5,5,5,5,5,4,4,4,4),
  Age = 1,
  M_age = c(4.73,4.83,3.77,3.85,5.68,5.77,7.06,11.18,7.24,11.42,5.73,3.28,
            20.4,20.3,20.77,20.69,20.91,20.67,29.62,28.00,36.61,34.24,41.37,38.88) ,
  SD_age = c(0.25,0.29,0.3,0.23,0.32,0.32,0.38,0.35,0.39,0.34,0.74,0.56,
             1.2,1.1,1.8,2.09,2.65,1.31,3.37,2.26,4.06,3.38,4.74,3.87),
  Other_age = NA,
  Remark1 = NA,
  Remark2 = NA,
  Remark3 = NA)


## Process Other_age information separately
df_stage2_Journal_Code_Mage_semicolon$Other_age[21:22] <- c("27-53","26-50")


#The above cases where there are multiple age groups will be recognized as NA in the code run, so they need to be removed.These removed data are the data contained in the data.frame above.
df_stage2_Journal_Code_Age <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Subjects_Recruitment_Area != 2) %>% 
  dplyr::mutate(M_age = as.numeric(M_age), SD_age = as.numeric(SD_age)) %>% 
  dplyr::mutate(M_age = round(M_age,2), SD_age = round(SD_age,2)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Type_N,Age,M_age,SD_age,Other_age,Remark1,Remark2,Remark3) %>% 
  dplyr::slice(-c(492,370,856,879,1406,724:726,
                  1413,1288,489,322,1331,1324,407,
                  362,374,495,1419,536:538,509,
                  510,1368,600,567,568,648,630,696))

## Merge data
df_stage2_Journal_Code_Age2 <- rbind(df_stage2_Journal_Code_Age,df_stage2_Journal_Code_Mage_multiple_group) %>% 
  rbind(df_stage2_Journal_Code_Mage_semicolon)

rm(df_stage2_Journal_Code_Mage_multiple_group,df_stage2_Journal_Code_Mage_semicolon,df_stage2_Journal_Code_Age_str)

#Special Note 1: In the process of M_age data, I found some data that may be outlier, so I grouped them based on "Sample_Type_N" and indeed found some abnormal data. In order to ensure that subsequent analysis is affected as little as possible, we will check it based on "df_stage2_Journal_Code2" and put the relevant code at the beginning of this section. This way, subsequent analysis will not be affected by these outlier. I hope the order here will not cause any inconvenience for you.

Summrise_MAge <- df_stage2_Journal_Code_Age2 %>%
  dplyr::filter(!is.na(M_age)) %>% 
  dplyr::group_by(Sample_Type_N) %>% 
  dplyr::summarise(Min_Mage = min(M_age),
                   Max_Mage  = max(M_age),
                   Mean_Mage  = mean(M_age))
rm(Summrise_MAge)

df_stage2_Journal_Code2_SampleType1 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Sample_Type_N == 1) ## M_age no outlier was found after sorting
rm(df_stage2_Journal_Code2_SampleType1)

df_stage2_Journal_Code2_SampleType2 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Sample_Type_N == 2) ## M_age no outlier was found after sorting
rm(df_stage2_Journal_Code2_SampleType2)

df_stage2_Journal_Code2_SampleType3 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Sample_Type_N == 3) ## 1 outlier was found after sorting
rm(df_stage2_Journal_Code2_SampleType3)

df_stage2_Journal_Code2_SampleType4 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Sample_Type_N == 4) ## outlier was found after sorting
rm(df_stage2_Journal_Code2_SampleType4)

df_stage2_Journal_Code2_SampleType5 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(Sample_Type_N == 5) ## I may need to re-process Sample_Type 5
rm(df_stage2_Journal_Code2_SampleType5)


## Count unreported/reported
#table(df_stage2_Journal_Code_Age$Age)


```


#### Informal process age data from Chinese sample in Chinese journal
```{r}
df_stage2_Journal_Code_MAge <- df_stage2_Journal_Code_Age2 %>% 
  dplyr::select(Article_IDs,M_age,Remark1,Remark2) %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!is.na(M_age)) %>% 
  dplyr::mutate(ageBins = cut(M_age,
                breaks = c(-Inf,4.5,9.5,14.5,19.5,24.5,
                           29.5,34.5,39.5,44.5,49.5,
                           54.5,59.5,64.5,69.5,74.5,
                           79.5,84.5,89.5,94.5,Inf),
                labels = c("0~4","5~9","10~14","15~19","20~24",
                           "25~29","30~34","35~39","40~44","45~49",
                           "50~54","55~59","60~64","65~69","70~74",
                           "75~79","80~84","85~89", "90~94",">=95"),
                levels = c("0~4","5~9","10~14","15~19","20~24",
                           "25~29","30~34","35~39","40~44","45~49",
                           "50~54","55~59","60~64","65~69","70~74",
                           "75~79","80~84","85~89", "90~94",">=95"))) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2)) %>% 
  dplyr::mutate(Data_Source = "CHN Journal age",n=as.numeric(n))


## Add a blank line for age groups without data
df_stage2_Journal_Code_MAge_missgroup <- data.frame(
  ageBins =c( "75~79","80~84","85~89", "90~94",">=95"),
  n=0,
  Proportion = 0,
  Data_Source = "CHN Journal age")

df_CHN_Journal_Age <- rbind(df_stage2_Journal_Code_MAge,df_stage2_Journal_Code_MAge_missgroup)


## Split the data by year
df_stage2_Journal_Code_MAge_year <- df_stage2_Journal_Code_Age2 %>%
  dplyr::select(Article_IDs,M_age,Remark1,Remark2) %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!is.na(M_age)) %>%
  dplyr::mutate( Data_Source= substring(Article_IDs,1,4)) %>% 
  dplyr::group_by(Data_Source) %>% 
  dplyr::mutate(ageBins = cut(M_age,
                breaks = c(-Inf,4.5,9.5,14.5,19.5,24.5,
                           29.5,34.5,39.5,44.5,49.5,
                           54.5,59.5,64.5,69.5,74.5,
                           79.5,84.5,89.5,94.5,Inf),
                labels = c("0~4","5~9","10~14","15~19","20~24",
                           "25~29","30~34","35~39","40~44","45~49",
                           "50~54","55~59","60~64","65~69","70~74",
                           "75~79","80~84","85~89", "90~94",">=95"),
                levels = c("0~4","5~9","10~14","15~19","20~24",
                           "25~29","30~34","35~39","40~44","45~49",
                           "50~54","55~59","60~64","65~69","70~74",
                           "75~79","80~84","85~89", "90~94",">=95"))) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2)) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(Data_Source= ifelse( Data_Source == "2008","CHN Journal age 2008", ifelse( Data_Source == "2018", "CHN Journal age 2018","CHN Journal age 2021")))

## Add a blank line for age groups without data
Data_Source_num <- 1:22

df_stage2_Journal_Code_MAge_year_missgroup <- data.frame(
  Data_Source= case_when(Data_Source_num %in% 1:10 ~ "CHN Journal age 2008",
                        Data_Source_num %in% 11:15 ~ "CHN Journal age 2018",
                        TRUE ~ "CHN Journal age 2021"),
  ageBins = c("45~49","50~54","55~59","60~64","70~74","75~79","80~84",
                "85~89", "90~94",">=95",
                 "75~79","80~84","85~89", "90~94",">=95",
                "55~59","70~74","75~79","80~84","85~89", "90~94",">=95"),
  n = 0,
  Proportion =0)

df_stage2_Journal_Code_MAge_year <- df_stage2_Journal_Code_MAge_year %>% 
  rbind(df_stage2_Journal_Code_MAge_year_missgroup) %>% 
  dplyr::arrange(Data_Source,ageBins)

rm(df_stage2_Journal_Code_MAge_year_missgroup,df_stage2_Journal_Code_MAge_missgroup, Data_Source_num)

```


#### Process age data of census data
```{r}
## Process age data for the census 6
df_census6_Age <- df_census6 %>% 
  dplyr::filter(row_number() %% 6 == 0) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::rename(ageBins = 1, Proportion = 3) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>%
  dplyr::slice(-21) 

df_census6_Age$ageBins[20] <- ">=95"

df_census6_Age <- df_census6_Age %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census 6") %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(ageBins) %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
  


## Process age data for the census 7 
df_census7_Age <- df_census7 %>%
  dplyr::rename(ageBins = 1,Proportion = 5) %>% 
  dplyr::filter(str_detect(ageBins,"岁")) %>%
  dplyr::select(1,2,5) %>% 
  dplyr::mutate(Proportion = as.numeric(Proportion)) %>% 
  dplyr::mutate(ageBins = str_remove(ageBins, "岁")) %>%
  dplyr::mutate(ageBins = str_replace_all(ageBins, "-", "~")) %>% 
  dplyr::slice(-21)

df_census7_Age$ageBins[20] <- ">=95" 
df_census7_Age$Proportion[20] <- 0.06+0.01


df_census7_Age <- df_census7_Age %>% 
  dplyr::group_by(ageBins) %>% 
  dplyr::summarise(Proportion = sum(Proportion)) %>% 
  dplyr::mutate(Data_Source = "Census 7") %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(ageBins = factor(ageBins, 
                                 levels =c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))
```


## Process age data from BTS
```{r}
BTS_age_list <- list()

for(i in seq_along(BTS_data)){
  
  BTS_data_name <- names(BTS_data)[i]
  
  if("Age" %in% names(BTS_data[[i]])){
    
    BTS_age <- BTS_data[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(-Inf,4.5,9.5,14.5,19.5,24.5,
                                           29.5,34.5,39.5,44.5,49.5,
                                           54.5,59.5,64.5,69.5,74.5,
                                           79.5,84.5,89.5,94.5,Inf),
                                labels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" ),
                                levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" ))) #%>% 
    #dplyr::count(ageBins) %>% 
    #dplyr::mutate(Proportion = round((n/sum(n))*100,2),
     #             BTS_data_source = BTS_data_name)
  

 
  
BTS_age_list[[BTS_data_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_data_name))  
  } 
}


## merge data.frame in list
BTS_age <-  bind_rows(BTS_age_list)

## 
#BTS_age_country_datasourse <- BTS_age %>% 
 # dplyr::distinct(BTS_data_source,ISO3)

#BTS_agebins_template <- expand.grid(ISO3 = BTS_age_country_datasourse$ISO3,
 #           BTS_data_source = BTS_age_country_datasourse$BTS_data_source,
  #          ageBins = Age_bins) %>% 
  #dplyr::distinct(ISO3,BTS_data_source,ageBins)

#BTS_age <- full_join(BTS_agebins_template, BTS_age, by = c("ISO3", "BTS_data_source", "ageBins")) %>% 
 # dplyr::mutate(n = replace_na(n,0),
  #              Proportion = replace_na( Proportion,0))


#bts1 <- BTS_age_list[[1]]
#bts2 <- BTS_data[[1]]

```


## Filter CHN age data from BTS, Combine BTS data and CHN journal data
```{r}
BTS_CHN_age <- BTS_age %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS CHN age")

## add 3 rows of ageBins without data
BTS_CHN_age_3rows <- data.frame(ageBins = c("0~4","5~9","10~14"),
                                n = 0,
                                Proportion = 0,
                                Data_Source = "BTS CHN age")

## combine 2 dataframe
Journal_BTS_CHN_age <- bind_rows(BTS_CHN_age,BTS_CHN_age_3rows,df_CHN_Journal_Age)


## set ageBins as factor to plot
Journal_BTS_CHN_age <- Journal_BTS_CHN_age %>% 
  dplyr::mutate(ageBins = factor(ageBins,
                                 levels = c("0~4","5~9","10~14","15~19","20~24",
                                 "25~29","30~34","35~39","40~44","45~49",
                                 "50~54","55~59","60~64","65~69","70~74",
                                 "75~79","80~84","85~89", "90~94",">=95" )))

```


## Visualize age data from Chinese journals and census7
```{r}
#Journal_BTS_CHN_age <- ggplot(BTS_CHN_age, aes(x=Proportion, y=BTS_data_source, fill=ageBins)) +
 # geom_col(alpha = .75)+
#  labs(y="Data Source") + 
 # scale_fill_discrete(label=c("0~17", "18~25", "26~40", "41~59",">=60" )) +
#  theme_classic()+
  #guides(y="axis_nested") +
 # theme(legend.title = element_text(size = 20,family = "serif"),
  #      axis.title= element_text(size = 20,family = "serif"),
   #     axis.text = element_text(size = 20,family = "serif"),
     #   strip.text = element_text(size = 20,family = "serif"),
    #    strip.background = element_rect(fill = NA,color = NA),
      #  panel.border = element_rect(fill = NA,color = "black")) +
  #scale_x_continuous(breaks = seq(0, 100, by = 10),expand = c(0,0))+
#  scale_y_discrete(expand = c(0,0))

#ggsave("Journal_BTS_CHN_age.pdf", Journal_BTS_CHN_age, device = "pdf", width=18, height = 9)

#Journal_BTS_CHN_age

Fig_Journal_BTS_CHN_age <- ggplot(data= Journal_BTS_CHN_age, aes(x=ageBins, y=ifelse(Data_Source=="BTS CHN age", -Proportion, Proportion),fill = Data_Source)) +
  geom_col(alpha=0.8, width = 1) +
  coord_flip() +
  labs(y="Proportion", x = "Age bins", color=NULL)+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position ="bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))


ggsave("Fig_Journal_BTS_CHN_age.pdf", Fig_Journal_BTS_CHN_age, device = "pdf", width=16, height = 9)

Fig_Journal_BTS_CHN_age
```


## Reprocess age for Bayesian multinomial test
### Reprocess BTS CHN age in psychological development stages
```{r}
BTS_age_list_PsyStages <- list()

for(i in seq_along(BTS_data)){
  
  BTS_data_name <- names(BTS_data)[i]
  
  if("Age" %in% names(BTS_data[[i]])){
    
    BTS_age <- BTS_data[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(0, 17.5, 25.5, 40.5, 59.5, Inf),
                                labels = c("0~17","18~25","26~40", "41~59", ">=60"),
                                levels = c("0~17","18~25","26~40", "41~59", ">=60")))
  
BTS_age_list_PsyStages[[BTS_data_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_data_name))  
  } 
}


## merge data.frame in list
BTS_age_PsyStages <-  do.call(rbind,BTS_age_list_PsyStages)
```


### Reprocess BTS CHN age in 10-year-old segment
```{r}
BTS_age_list_interval10 <- list()

for(i in seq_along(BTS_data)){
  
  BTS_data_name <- names(BTS_data)[i]
  
  if("Age" %in% names(BTS_data[[i]])){
    
    BTS_age <- BTS_data[[i]] %>% 
      dplyr::filter(!is.na(Age) & !is.na(ISO3)) %>% 
      dplyr::select(Article_Id,Age,ISO3) %>% 
      #dplyr::group_by(ISO3) %>% 
      dplyr::mutate(ageBins = cut(Age,
                                breaks = c(-Inf, 9.5, 19.5, 29.5, 30.5, 40.5, 59.5, Inf),
                                labels = c("0~9","10~19","20~29", "30~39", "40~49", "50~59", ">=60"),
                                levels = c("0~9","10~19","20~29", "30~39", "40~49", "50~59", ">=60")))
  
BTS_age_list_interval10[[BTS_data_name]] <- BTS_age
  
} else {  
 
    cat(sprintf("Skipping '%s' because it does not contain a 'Age' column.\n", BTS_data_name))  
  } 
}


## merge data.frame in list
BTS_age_interval10 <-  do.call(rbind,BTS_age_list_interval10)
```


### Filter BTS CHN data
```{r}
## psychological development stages in BTS
BTS_CHN_age_PsyStages <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(1,4) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS CHN age")# %>% 
 # tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion) %>% 
  #dplyr::select(-2)


## 10-year-old segment in BTS
BTS_CHN_age_interval10 <- BTS_age_interval10 %>% 
  dplyr::filter(ISO3 == "CHN") %>% 
  dplyr::select(1,4) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Data_Source = "BTS CHN age") #%>% 
  #tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion) %>% 
  #dplyr::select(-2)

```


### Reprocess Chinses journal data in psychological development stages
```{r}
## psychological development stages in CHN journal
Journal_age_PsyStages <- df_stage2_Journal_Code_Age2 %>% 
  dplyr::select(Article_IDs,M_age,Remark1,Remark2) %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!is.na(M_age)) %>% 
  dplyr::mutate(ageBins = cut(M_age,
                breaks = c(0, 17.5, 25.5, 40.5, 59.5, Inf),
                labels = c("0~17","18~25","26~40", "41~59", ">=60"),
                levels = c("0~17","18~25","26~40", "41~59", ">=60"))) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2)) %>% 
  dplyr::mutate(Data_Source = "CHN Journal age",n=as.numeric(n))
```


### Reprocess Chinses journal data in 10-year-old segment
```{r}
## 10-year-old-segment in CHN journal
Journal_age_interval10 <- df_stage2_Journal_Code_Age2 %>% 
  dplyr::select(Article_IDs,M_age,Remark1,Remark2) %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::filter(!is.na(M_age)) %>% 
  dplyr::mutate(ageBins = cut(M_age,
                breaks = c(-Inf, 9.5, 19.5, 29.5, 30.5, 40.5, 59.5, Inf),
                labels = c("0~9","10~19","20~29", "30~39", "40~49", "50~59", ">=60"),
                levels = c("0~9","10~19","20~29", "30~39", "40~49", "50~59", ">=60"))) %>% 
  dplyr::count(ageBins) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2)) %>% 
  dplyr::mutate(Data_Source = "CHN Journal age",n=as.numeric(n))
```


### Combine two CHN data to Bayesian multinomial test(PsyStages)
```{r}
Journal_BTS_CHN_PsyStages_bayes <- bind_rows(BTS_CHN_age_PsyStages,Journal_age_PsyStages) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


BF_H1_PsyStages_Journal_BTS <- BayesMultiNomial(dataset = Journal_BTS_CHN_PsyStages_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "CHN Journal age")

```


### Combine two CHN data to Bayesian multinomial test(interval10)
```{r}
BTS_CHN_age_interval10 <- BTS_CHN_age_interval10 %>% 
  dplyr::add_row(ageBins = "0~9", n = 0, Proportion = 0, Data_Source = "BTS CHN age")

Journal_BTS_CHN_interval10_bayes <- bind_rows(BTS_CHN_age_interval10,Journal_age_interval10) %>% 
  dplyr::select(-2) %>% 
  tidyr::pivot_wider(names_from = Data_Source, values_from = Proportion)


BF_H1_interval10_Journal_BTS <- BayesMultiNomial(dataset = Journal_BTS_CHN_interval10_bayes,
                                          factor = "ageBins",
                                          observed = "BTS CHN age",
                                          expected = "CHN Journal age")
```


When we divide the age into 10 years,we found strong evidence for the $H_1$ that the age distribution from BTS data is different from that of Chinese journal data, with $Log(BF_{10})$ = `r BF_H1_interval10_Journal_BTS$BF$LogBF10`.

When we divide age into stages of psychological development, we found strong evidence for the $H_1$ that the age distribution from BTS data is different from that of Chinese journal data, with $Log(BF_{10})$ = `r BF_H1_PsyStages_Journal_BTS$BF$LogBF10`.

## Test the 2st hypothesis
### Age
#### Visualize age data from Chinese journals, BTS CHN and census7
```{r}
Fig_Journal_BTS_Census_age <- ggplot(data= df_census7_Age, 
       aes(x=ageBins, y = Proportion, fill="Census 7")) +
  geom_col(alpha=0.5, width = 1) +
  geom_line(data = Journal_BTS_CHN_age, aes(x=ageBins, 
                y = Proportion, group = Data_Source,color = Data_Source),size =1)+
  scale_fill_manual(values=c("Census 7"="#00BFC4")) +  
  scale_color_manual(values=c("CHN Journal age"="red", "BTS CHN age" = c("blue"))) +
  scale_y_continuous(limits = c(0,40))+
  coord_flip() +
  labs(y="Proportion", x = "Age bins")+
  theme_classic()+
  theme(panel.border =element_rect(fill=NA,color="black"),
        legend.position = "bottom",
        legend.box.spacing = unit(2,"pt"),
        legend.text = element_text(size = 16, family = "serif"),
        legend.title = element_blank(),
        axis.title = element_text(size = 16,family = "serif"),
        axis.text = element_text(size = 16,family = "serif"))

ggsave("Fig_Journal_BTS_Census_age.pdf", Fig_Journal_BTS_Census_age, device = "pdf", width=18, height = 9)

Fig_Journal_BTS_Census_age
```


### Region
#### Process Subjects_Recruitment_Area data from Chinese journal
```{r}
df_CHN_Journal_Area <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::select(Article_IDs,Study_Number_N,Subjects_Group_N,Subjects_Recruitment_Area)

df_CHN_Journal_Area_02 <- df_CHN_Journal_Area %>% 
  dplyr::filter(Subjects_Recruitment_Area == 0 | Subjects_Recruitment_Area == 2)

df_CHN_Journal_Area_1 <- df_CHN_Journal_Area %>% 
  dplyr::filter(Subjects_Recruitment_Area != 0 & Subjects_Recruitment_Area != 2)

df_CHN_Journal_Area_1$Subjects_Recruitment_Area <- gsub("[；、,:]", ";", df_CHN_Journal_Area_1$Subjects_Recruitment_Area)

df_CHN_Journal_Area_Separate <- df_CHN_Journal_Area_1 %>% 
  tidyr::separate_rows(Subjects_Recruitment_Area,sep = ";") %>% 
  dplyr::mutate(Subjects_Recruitment_Area = gsub("自治区|回族自治区|维吾尔自治区|壮族自治区","",Subjects_Recruitment_Area))


Province <- c("新疆","西藏","甘肃","青海","内蒙古",
              "宁夏","四川","重庆","陕西","贵州","云南",
              "北京","山西","河北","河南","湖北","湖南",
              "广西","广东","香港","澳门","台湾","海南",
              "黑龙江","吉林","辽宁","天津","山东","江苏",
              "安徽","上海","浙江","江西","福建")

df_CHN_Journal_Area_Province <- df_CHN_Journal_Area_Separate %>% 
  dplyr::filter(Subjects_Recruitment_Area %in% Province)

df_CHN_Journal_Area_Province_add <- data.frame(
 Article_IDs = 20182261,
 Study_Number_N = 1,
 Subjects_Group_N = "小学生",
 Subjects_Recruitment_Area = c("河南","甘肃"))

df_CHN_Journal_Area_Province <- rbind(df_CHN_Journal_Area_Province,df_CHN_Journal_Area_Province_add)

df_CHN_Journal_Province_count <- df_CHN_Journal_Area_Province %>% 
  dplyr::count(Subjects_Recruitment_Area) %>% 
  dplyr::mutate(Proportion = round((n/sum(n))*100,2),
                Count_Bins = cut(Proportion,
                                 breaks = c(-Inf,1,5,10,Inf),
                labels = c("<1","1~5","5~10",">=10")))
```


#### Processing of provincial distribution of population for census7
```{r message=FALSE, warning=FALSE, include=FALSE}
df_census7_province <- readxl::read_xls("A0101.xls") %>% 
  dplyr::select(1,5) %>% 
  dplyr::rename(province = 1, population = 2) %>% 
  dplyr::filter(!is.na(province)) %>% 
  dplyr::slice(-c(1:2)) %>% 
  dplyr::mutate(population = as.numeric(population))

df_census7_3 <- data.frame(province = c("台湾","香港","澳门"),
                           population =c(23561236,7474200,683218))
df_census7_province <- rbind(df_census7_province,df_census7_3) %>% 
  dplyr::mutate(proportion = round((population / sum(population))*100,2)) %>% 
  dplyr::mutate(proportion_bins = cut(proportion,
                                      breaks = c(-Inf,1,5,10,Inf),
                                      labels = c("<1","1~5","5~10",">=10")))

df_census7_province$province <- gsub(" ", "", df_census7_province$province)  
```


#### Visualize geographic distribution
```{r}
API_pre <-  "http://xzqh.mca.gov.cn/data/"
## 读取全国数据
China <-  st_read(dsn = paste0(API_pre, "quanguo.json"), stringsAsFactors=FALSE) 
## 使用 4326 地理坐标系
st_crs(China) <-  4326

# 读取国界线数据
China_line <-  st_read(dsn = paste0(API_pre, "quanguo_Line.geojson"), stringsAsFactors=FALSE) 
st_crs(China_line) <-  4326
## 选择区划代码为国界线的区域
gjx <- China_line[China_line$QUHUADAIMA == "guojiexian",]

# 读取省份经纬度
province <- readxl::read_xlsx("province.xlsx")
colour <- readxl::read_xlsx("colour.xlsx") %>% 
  dplyr::mutate(QUHUADAIMA = as.character(QUHUADAIMA),
                colour_CHN_Journal = 0,
                colour_census7 = 0)

colour$QUHUADAIMA[which(colour$province =="重庆")] <- "500000"

colour$colour_census7[colour$province %in% df_census7_province$province [df_census7_province$proportion_bins == "<1"]] <- 1
colour$colour_census7[colour$province %in% df_census7_province$province [df_census7_province$proportion_bins == "1~5"]] <- 2
colour$colour_census7[colour$province %in% df_census7_province$province [df_census7_province$proportion_bins == "5~10"]] <- 3
colour$colour_census7[colour$province %in% df_census7_province$province [df_census7_province$proportion_bins == ">=10"]] <- 4



colour$colour_CHN_Journal[which(colour$province =="台湾"| colour$province =="澳门")] <- "0"

colour$colour_CHN_Journal[colour$province %in% df_CHN_Journal_Province_count $Subjects_Recruitment_Area[df_CHN_Journal_Province_count$Count_Bins == "<1"]] <- 1
colour$colour_CHN_Journal[colour$province %in% df_CHN_Journal_Province_count $Subjects_Recruitment_Area[df_CHN_Journal_Province_count$Count_Bins == "1~5"]] <- 2
colour$colour_CHN_Journal[colour$province %in% df_CHN_Journal_Province_count $Subjects_Recruitment_Area[df_CHN_Journal_Province_count$Count_Bins == "5~10"]] <- 3
colour$colour_CHN_Journal[colour$province %in% df_CHN_Journal_Province_count $Subjects_Recruitment_Area[df_CHN_Journal_Province_count$Count_Bins == ">=10"]] <- 4

colour <- colour %>%
  dplyr::mutate(colour_CHN_Journal = factor(colour_CHN_Journal, 
                                          levels = c("0","1", "2", "3", "4")),
                colour_census7 = factor(colour_census7,
                                         levels = c("0","1", "2", "3", "4")))

China <- dplyr::left_join(China,colour,by= "QUHUADAIMA")
China$colour_CHN_Journal[which(China$province =="台湾")] <- "0"


Journal_Area <- ggplot() +
  geom_sf(data = China,aes(fill = factor(colour_CHN_Journal))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Subjects recruitment area distribution") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.title = element_blank(),
        legend.position = c(0.2, 0.2),
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())

Census7_Area <- ggplot() +
  geom_sf(data = China,aes(fill = factor(colour_census7))) +
  scale_fill_manual(values = c("#FFFFFF", "#C6DBEF","#6BAED6", "#2171B5", "#08306B"),
                    breaks = c("0","1","2", "3", "4"),
                    labels = c("0", "<1%","<5%", "<10%",">=10%"),drop = FALSE) +
  geom_sf(data = gjx) +
  labs(title = "Census7 population area distribution") +
  theme(plot.title = element_text(color = "black",size = 16,
                                  face = "bold",vjust = 0.1, hjust = 0.5),
        legend.position = "none",
        panel.grid = element_blank(),
        panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank())+
  annotation_north_arrow(location = 'tl',which_north = 'false',
                         style = north_arrow_orienteering())

Journal_region_distribution <- Census7_Area + Journal_Area + plot_layout(guides = "collect")+
  plot_annotation(tag_levels = 'A', title = "Area distribution",
                  theme = theme(plot.title = element_text(size = 24))) + 
  theme(plot.tag = element_text(size = 20))

ggsave("Journal_region_distribution.pdf", Journal_region_distribution, device = "pdf", width=18, height = 15)

Journal_region_distribution

#table(df_stage2_Journal_Code2$Educational_Attainment_N)
```


### Educational attainment
#### Process educational attainment data from Chinese journal
```{r}
df_CHN_edu <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2_N)) %>% 
  dplyr::filter(Educational_Attainment_N == 1) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size,M_age,SD_age,Sample_Type_N,Educational_Attainment_N,Educational_Attainment_info_N)

writexl::write_xlsx(df_CHN_edu,"df_CHN_edu.xlsx")
```


### Ethnicity
#### Process ethnicity data from Chinese journal
```{r}
## In informal code stage, Because our code group haveare multiple coders, in order to reduce coding differences between individuals based on criteria and understanding, our coding for ethnic groups does not include information about native minority languages. For example: Tibetan language. I will now supplement this.

df_stage2_Journal_Code2$Ethnicity_info[768] <- "汉族"

### Article_IDs 20181113 
df_stage2_Journal_Code2$Ethnicity[1291:1292] <- 1
df_stage2_Journal_Code2$Ethnicity_info[1291:1292] <- c("维吾尔族","维吾尔族")

### Article_IDs 20211018
df_stage2_Journal_Code2$Ethnicity[1634:1635] <- 1
df_stage2_Journal_Code2$Ethnicity_info[1634:1635] <- c("藏族","藏族")

### Article_IDs 20213168
df_stage2_Journal_Code2$Ethnicity[1603] <- 1
df_stage2_Journal_Code2$Ethnicity_info[1603] <- "汉族;少数民族"

### Article_IDs 20181017
df_stage2_Journal_Code2$Ethnicity[760:761] <- 1
df_stage2_Journal_Code2$Ethnicity_info[760:761] <- "蒙古族"

### Article_IDs 20211013
df_stage2_Journal_Code2$Ethnicity[1587:1588] <- 1
df_stage2_Journal_Code2$Ethnicity_info[1587:1588] <- "锡伯族"

df_CHN_Ethnicity <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Size,
                Ethnicity,Ethnicity_info) %>% 
  dplyr::filter(Ethnicity == 1) %>% 
  tidyr::separate_rows(Ethnicity_info,sep = ";") %>% 
  dplyr::filter(!grepl("少数|汉族|其他",Ethnicity_info))


#table(df_CHN_Ethnicity$Ethnicity) 1507~0, 63~1

table_ethnicity <- data.frame(table(df_CHN_Ethnicity$Ethnicity_info))

ethnicity_add <- c("土家族","回族","蒙古族","畲族","满族","苗族","壮族","黎族","彝族","布依族")

table_ethnicity <- table_ethnicity %>% 
  dplyr::mutate(Freq = ifelse(Var1 %in% ethnicity_add, Freq+1, Freq))


## sample size and different ethnicity
df_CHN_Ethnicity$Sample_Size[2] <- 251
df_CHN_Ethnicity$Sample_Size[3] <- 297
df_CHN_Ethnicity$Sample_Size[4] <- 110
df_CHN_Ethnicity$Sample_Size[5] <- 61

df_CHN_Ethnicity$Sample_Size[6:21] <- c(14,16,18,9,20,10,18,12,19,10,
                                           19,12,17,15,21,13)

df_CHN_Ethnicity$Sample_Size[32:33] <- c(4,0)

df_CHN_Ethnicity$Sample_Size[34:62] <- c(139,108,71,51,50,40,38,31,
                                         27,24,18,16,16,11,9,6,5,4,
                                         3,3,3,2,2,1,1,1,1,1,1)

df_CHN_Ethnicity$Sample_Size[63:64] <- c(30,60)

df_CHN_Ethnicity$Sample_Size[65] <- 1006

df_CHN_Ethnicity$Sample_Size[72] <- 30

## ethnicity sample size
df_CHN_Ethnicity_group <- df_CHN_Ethnicity %>% 
  dplyr::mutate(Sample_Size =as.numeric(Sample_Size)) %>% 
  dplyr::group_by(Ethnicity_info) %>% 
  dplyr::summarise(Sample = sum(Sample_Size)) %>% 
  dplyr::ungroup()


Ethnicity_Article_IDs_number <- df_CHN_Ethnicity %>% 
  dplyr::distinct(Article_IDs)

Code2_Article_IDs_number <-  df_stage2_Journal_Code2 %>% 
  dplyr::distinct(Article_IDs)
  
### 17/997
```


## Test the 3st hypothesis

### Region
#### Process region data of BTS 
```{r}
if(!require("maps")) install.packages("maps")

## creat a world map
world_map <- ggplot2::map_data(map = "world")

world_map2 <- world_map %>% 
  dplyr::mutate(region = iso.alpha(region),
                long = ifelse(long >= -180 & long <= -30, 
                              long + 360, long),
                region = ifelse(region == "TW","CN",region))  


BTS_region <- BTS_Overview2 %>% 
  dplyr::mutate(Proportion = Proportion * 0.01) %>% 
  dplyr::mutate(Proportion_bins = if_else(Proportion >= 0.16, "0.16-1",
                                          if_else(Proportion < 0.16 & Proportion >= 0.08, "0.08-0.16" ,
                                                  if_else(Proportion < 0.08 & Proportion >= 0.04, "0.04-0.08" , 
                                                          if_else(Proportion < 0.04 & Proportion >= 0.02, "0.02-0.04" , 
                                                                  if_else(Proportion < 0.02 & Proportion >= 0.01, "0.01-0.02" , 
                                                                          if_else(Proportion < 0.01 & Proportion >= 0.005, "0.005-0.01" ,         
                                                                                  if_else(Proportion < 0.005 & Proportion >= 0.0025, "0.0025-0.005", "0-0.0025"))))))))

```


#### Visualize geographic distribution of BTS
```{r}
Fig_BTS_region <- ggplot2::ggplot(BTS_region)+
  geom_map(aes(map_id = ISO2, fill = Proportion_bins), map = world_map2,show.legend = TRUE) +
  geom_polygon(data = world_map2, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
  xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) +
  scale_fill_manual(name = "sample proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1")) +
ggtitle("Geographical distribution of sample from BTS")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"), 
        legend.key.width = unit(15, "pt")  
        )

Fig_BTS_region
```


#### Visualize geographic distribution of world population
this data process and plot code from Liu and Hu, thanks them.
```{r}
wppdata <- read_csv("WPP2022.csv")


wppdata1 <- subset(wppdata, select = c("country_map","continent", "pop"))

wppdata3 <- dplyr::mutate(.data = wppdata1, percentage_pop = pop/7909295.151) 

#wppdata3 <- wppdata2 %>% dplyr::left_join(df_PSA001, by = "country_map")

#Merge data from Taiwan Province with data from mainland China
sum_of_cn <- sum(wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")])
wppdata3$percentage_pop[wppdata3$country_map %in% c("CN", "TW")] <- sum_of_cn

wppdata3$percentage_pop[wppdata3 $country_map == "GL"] <- NA



wppdata3$n_binned <- 
  if_else(wppdata3$percentage_pop >= 0.16, "0.16-1",
  if_else(wppdata3$percentage_pop < 0.16 & wppdata3$percentage_pop >= 0.08, "0.08-0.16" , 
   if_else(wppdata3$percentage_pop < 0.08 & wppdata3$percentage_pop >= 0.04, "0.04-0.08" , 
  if_else(wppdata3$percentage_pop < 0.04 & wppdata3$percentage_pop >= 0.02, "0.02-0.04" , 
   if_else(wppdata3$percentage_pop < 0.02 & wppdata3$percentage_pop >= 0.01, "0.01-0.02" , 
   if_else(wppdata3$percentage_pop < 0.01 & wppdata3$percentage_pop >= 0.005, "0.005-0.01" ,         
  if_else(wppdata3$percentage_pop < 0.005 & wppdata3$percentage_pop >= 0.0025, "0.0025-0.005",
      "0-0.0025"
    )
  )
 )
))))


wppdata4 <- wppdata3[complete.cases(wppdata3$percentage_pop), ]
# map of World people data 
world_population_map <- ggplot2::ggplot(wppdata4) +
  ggplot2::geom_map(aes(map_id = country_map, fill = n_binned), map = world_map2,show.legend = TRUE) +
  ggplot2::geom_polygon(data = world_map2, 
               aes(x = long, y = lat, group = group), 
               colour = 'black', size=0.1, fill = NA) + 
  theme_void() + 
   xlim(c(-30, 329)) + 
  ylim(c(-60, 90)) + 
  scale_fill_manual(name = "world people proportion",
                    values = c("#CCE5FF","#99CCFF", "#66B2FF","#3399FF","#0080FF" ,"#0066CC","#004C99","#003366"),
                    limits = c("0-0.0025", "0.0025-0.005", "0.005-0.01", "0.01-0.02", "0.02-0.04", "0.04-0.08","0.08-0.16", "0.16-1"),
                    drop = FALSE) +
ggtitle("Geographical distribution of world population")+
  theme(plot.title = element_text(hjust = 0.5, size = 15),
        legend.text = element_text(size = 10),  
        legend.title = element_text(size = 12),  
        legend.key.size = unit(3, "pt"),  
        legend.key.height = unit(3, "pt"),  
        legend.key.width = unit(15, "pt")  
        )
world_population_map

library(patchwork)

sample_map <- Fig_BTS_region + world_population_map + 
  plot_layout(ncol = 2, heights = c(4,4))+
  patchwork::plot_annotation(tag_levels = 'A')

ggsave("sample_map.pdf", sample_map, device = "pdf", width=18, height = 9)

sample_map 
```


### Gender
####  Process gender data 
```{r}
BTS_ALL_gender <- lapply(BTS_gender_list, function(df){
  
  df %>% 
    dplyr::select(ISO3,Data_Source,Gender) 
  
})

BTS_ALL_gender <- do.call(rbind, BTS_ALL_gender) 

## Filter n > 30
BTS_ALL_gender_tab <- BTS_ALL_gender %>%
  dplyr::group_by(ISO3) %>%
  dplyr::summarise(n=n(),.groups = "drop") %>% 
  dplyr::filter(n > 30) %>%
  dplyr::pull(ISO3)

BTS_ALL_gender <- BTS_ALL_gender %>% 
  dplyr::filter(ISO3 %in% BTS_ALL_gender_tab) %>% 
  dplyr::group_by(ISO3,Gender) %>%
  dplyr::summarise(n = n()) %>%
  dplyr::mutate(Proportion = round(n/sum(n),2)*100) %>%
  dplyr::ungroup() %>%
  dplyr::mutate(Data_Source = "BTS")

## Set factor levels according to gender proportion
BTS_ALL_gender_factor <- BTS_ALL_gender %>% 
  dplyr::filter(Gender == "Female") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)


## combine WEIRD data to visualization
WEIRD_code_gender <- WEIRD_code %>% 
  dplyr::filter(!is.na(iso3c)) %>% 
  dplyr::filter(iso3c %in% BTS_ALL_gender_factor)


Journal_BTS_ALL_gender <- BTS_ALL_gender %>% 
  dplyr::left_join(WEIRD_code_gender,by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>% 
  dplyr::mutate(ISO3 = factor(ISO3,levels = BTS_ALL_gender_factor)) %>% 
  dplyr::filter(!is.na(ISO3))

```


#### Visualization gender data
```{r}
Fig_Journal_BTS_ALL_gender <- ggplot(Journal_BTS_ALL_gender, aes(x=Proportion, y=ISO3,fill=Gender)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("female","male")) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free")

Fig_Journal_BTS_ALL_gender

ggsave("Fig_Journal_BTS_ALL_gender.pdf", Fig_Journal_BTS_ALL_gender, device = "pdf", width=18, height = 9)
```

#### Process age data (PsyStages)
```{r}
BTS_ALL_age <- BTS_age_PsyStages %>% 
  dplyr::filter(ISO3 %in% BTS_ALL_gender_tab) %>% 
  dplyr::group_by(ISO3,ageBins) %>% 
  dplyr::summarise(n=n()) %>% 
  dplyr::mutate(Proportion = round(n/sum(n)*100,2)) %>% 
  dplyr::ungroup()

BTS_ALL_age_factor <- BTS_ALL_age %>% 
  dplyr::filter(ageBins == "18~25") %>% 
  dplyr::arrange(Proportion) %>% 
  dplyr::pull(ISO3)

# dftabage <- data.frame(table(BTS_ALL_age_factor))
# dftabgender <- data.frame(table(BTS_ALL_age_factor))

BTS_ALL_age <- BTS_ALL_age %>% 
  dplyr::left_join(WEIRD_code2, by = c("ISO3" = "iso3c")) %>% 
  dplyr::mutate(WEIRD = ifelse(ISO3 == "XKX","WEIRD",WEIRD)) %>%
  dplyr::mutate(ISO3 = factor(ISO3,BTS_ALL_age_factor)) %>% 
  dplyr::filter(!is.na(ageBins))
  
  
```


#### Visualize gender data for countries around the world in BTS
```{r}
Fig_Journal_BTS_ALL_age <- ggplot(BTS_ALL_age, aes(x=Proportion, y=ISO3, fill=ageBins)) +
  geom_col(alpha = .75)+
  labs(y="Countries") + 
  scale_fill_discrete(label=c("0~17", "18~25", "26~40", "41~59",">=60" )) +
  theme_classic()+
  #guides(y="axis_nested") +
  theme(legend.title = element_text(size = 15,family = "serif"),
        axis.title= element_text(size = 15,family = "serif"),
        axis.text = element_text(size = 10,family = "serif"),
        strip.text = element_text(size = 15,family = "serif"),
        strip.background = element_rect(fill = NA,color = NA),
        panel.border = element_rect(fill = NA,color = "black")) +
  scale_x_continuous(breaks = seq(0, 100, by = 10)) +
  facet_wrap(~ WEIRD, scales = "free") 

ggsave("Fig_Journal_BTS_ALL_age.pdf", Fig_Journal_BTS_ALL_age, device = "pdf", width=18, height = 9)

Fig_Journal_BTS_ALL_age
```



#### Process age data (PsyStages)
```{r}

```


# Exploratory analysis
## Abstract1 subjects information reported of Chinese journal
### Process Abstract data
```{r message=FALSE, warning=FALSE}
### In our coding, different subject groups will make the same article have multiple rows of data, but there is only one abstract and the multi-rows Abstract1 should be consistent. So, first, I check whether Abstract1 is consistent.

Abstract_subj_info_filter <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Abstract1,Sample_Type_N,Sample_Type_info_N,
                Abstract2)


Abstract1_subj_info_equl <- Abstract_subj_info_filter %>%
  dplyr::group_by(Article_IDs) %>%  
  dplyr::mutate(Same_Abstract1 = n_distinct(Abstract1) == 1) %>%  
  dplyr::ungroup() 

### Article_IDs 20081099
df_stage2_Journal_Code2$Abstract1[17] <- 0

### Article_IDs 20183099
df_stage2_Journal_Code2$Abstract1[382] <- 14

### Article_IDs 20083116
df_stage2_Journal_Code2$Abstract1[1460] <- 14

### Article_IDs 20181236
df_stage2_Journal_Code2$Abstract1[1506] <- 145

### Article_IDs 20081096
df_stage2_Journal_Code2$Abstract1[15] <- 1234

### Article_IDs 20185111
df_stage2_Journal_Code2$Abstract1[1380] <- 0

### Article_IDs 20211025
df_stage2_Journal_Code2$Abstract1[1590:1591] <- "1234b"

### Article_IDs 20213237
df_stage2_Journal_Code2$Abstract1[1641:1642] <- 1

## Then, I check that the encoding of Abstract1 and Abstract2 is exactly the same
Abstract1_Abstract2 <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Type_N,Abstract2,Abstract1) %>% 
  dplyr::filter(grepl("1",Sample_Type_N)) %>% 
  dplyr::filter(grepl("1",Abstract1) & Abstract2 != 1)

### Article_IDs 20213252
df_stage2_Journal_Code2$Abstract2[490] <- 1

### Article_IDs 20185009
df_stage2_Journal_Code2$Abstract1[867:868] <- 0

### Article_IDs 20181100
df_stage2_Journal_Code2$Abstract2[1278:1279] <- 1

### Article_IDs 20213184
df_stage2_Journal_Code2$Abstract2[1605] <- 1


### Process demographic information reports for different samples in the Abstract1
Abstract1_subj_info_equl <- Abstract1_subj_info_equl %>% 
  dplyr::filter(Sample_Type_N != 5) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Sample_type3 = ifelse(all(Sample_Type_N == 1),1,
                                          ifelse(any(grepl("1",Sample_Type_N)) & any(Sample_Type_N !=1),2,
                                      3))) %>% 
  dplyr::ungroup()



### Abstract2 (univeristy students report)
Abstract2_report_NA <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::filter(grepl("1",Sample_Type_N)) %>% 
  dplyr::select(Article_IDs,Study_Number,Subjects_Group,Sample_Type_N,Abstract2,Abstract1) %>% 
  dplyr::filter(is.na(Abstract2))

df_stage2_Journal_Code2 <- df_stage2_Journal_Code2 %>% 
  dplyr::mutate(Abstract2 = ifelse(is.na(Remark1) & !grepl("重复",Remark2) & 
                                     !grepl("2",Subjects_Recruitment_Area) & 
                                     grepl("1",Sample_Type_N) & Abstract1 == 0,0,Abstract2))

### Article_IDs 20183311
df_stage2_Journal_Code2$Abstract2[161] <- 0

### Article_IDs 20182075
df_stage2_Journal_Code2$Abstract2[776] <- 1

### Article_IDs 20082324
df_stage2_Journal_Code2$Abstract2[950] <- 0

### Article_ID 20082024
df_stage2_Journal_Code2$Abstract2[1440] <- 1

### Article_IDs 20082042
df_stage2_Journal_Code2$Abstract1[1451] <- 123
df_stage2_Journal_Code2$Abstract2[1451] <- 1

### Article_IDs 20213168
df_stage2_Journal_Code2$Abstract2[1603] <- 1

### Article_IDs 20213192
df_stage2_Journal_Code2$Abstract2[1611:1612] <- 0
```


### Specific reporting data
```{r message=FALSE, warning=FALSE}
Abstract1_subj_info <- Abstract1_subj_info_equl %>% 
  dplyr::mutate(Abstract1_demo_info = ifelse(Abstract1 == 0,0,1),  
                Abstract1_sample_info = ifelse(grepl("1",Abstract1),1,0)) %>% 
  dplyr::select(Article_IDs,Abstract1_demo_info,Abstract1_sample_info,Sample_type3) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() ### Abstract1_demo_info means demographic information report, Abstract2_sample_info means sample type report  

### the demographic report of different sample type in Abstract1
Abstract1_demo_info <- Abstract1_subj_info %>% 
  dplyr::group_by(Sample_type3,Abstract1_demo_info) %>% 
  dplyr::summarise(report = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(proportion = round(report/sum(report),2))
  
### the sample information report of different sample type in Abstract1
#Abstract1_sample_info <- Abstract1_subj_info %>% 
 # dplyr::group_by(Sample_type3,Abstract1_sample_info) %>% 
  #dplyr::summarise(report = n()) %>% 
  #dplyr::ungroup() %>% 
  #dplyr::mutate(proportion = round(report/sum(report),2))


Abstract2_report <- df_stage2_Journal_Code2 %>% 
  dplyr::filter(is.na(Remark1) & !grepl("重复",Remark2)) %>%
  dplyr::filter(!grepl("2",Subjects_Recruitment_Area)) %>% 
  dplyr::filter(grepl("1",Sample_Type_N)) %>% 
  dplyr::group_by(Article_IDs) %>% 
  dplyr::mutate(Same_Abstract2 = n_distinct(Abstract2) == 1) %>%  ## check multiple subjects group Abstract2 whether is consistent.
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::group_by(Abstract2) %>% 
  dplyr::summarise(report = n()) %>% 
  dplyr::ungroup() %>% 
  dplyr::mutate(proportion = round(report/sum(report),2))

```


